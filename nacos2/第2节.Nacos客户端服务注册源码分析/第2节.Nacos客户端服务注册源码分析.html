<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第2节.Nacos客户端服务注册源码分析 | Nacos Guide</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="分享微服务组件Nacos，学习其源码与思想">
    
    <link rel="preload" href="/nacos-guide/assets/css/0.styles.315a301c.css" as="style"><link rel="preload" href="/nacos-guide/assets/js/app.66cd9b59.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/2.fd0c06d4.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/8.6c4ec18c.js" as="script"><link rel="prefetch" href="/nacos-guide/assets/js/10.742b4de3.js"><link rel="prefetch" href="/nacos-guide/assets/js/11.e5dec651.js"><link rel="prefetch" href="/nacos-guide/assets/js/12.7d0e689a.js"><link rel="prefetch" href="/nacos-guide/assets/js/13.45ac1958.js"><link rel="prefetch" href="/nacos-guide/assets/js/14.6b452d3d.js"><link rel="prefetch" href="/nacos-guide/assets/js/15.7bf50d6e.js"><link rel="prefetch" href="/nacos-guide/assets/js/16.813f3080.js"><link rel="prefetch" href="/nacos-guide/assets/js/17.ec283283.js"><link rel="prefetch" href="/nacos-guide/assets/js/18.357bed57.js"><link rel="prefetch" href="/nacos-guide/assets/js/19.a656dd30.js"><link rel="prefetch" href="/nacos-guide/assets/js/20.f382b739.js"><link rel="prefetch" href="/nacos-guide/assets/js/21.355bcc58.js"><link rel="prefetch" href="/nacos-guide/assets/js/22.6a900892.js"><link rel="prefetch" href="/nacos-guide/assets/js/23.8c89a62d.js"><link rel="prefetch" href="/nacos-guide/assets/js/24.550fdc1f.js"><link rel="prefetch" href="/nacos-guide/assets/js/25.c0db29f8.js"><link rel="prefetch" href="/nacos-guide/assets/js/26.800ecd55.js"><link rel="prefetch" href="/nacos-guide/assets/js/27.64e0bb30.js"><link rel="prefetch" href="/nacos-guide/assets/js/28.6f1beecb.js"><link rel="prefetch" href="/nacos-guide/assets/js/29.7d1e866d.js"><link rel="prefetch" href="/nacos-guide/assets/js/3.c3936cdc.js"><link rel="prefetch" href="/nacos-guide/assets/js/4.810db986.js"><link rel="prefetch" href="/nacos-guide/assets/js/5.c131b314.js"><link rel="prefetch" href="/nacos-guide/assets/js/6.af062ec9.js"><link rel="prefetch" href="/nacos-guide/assets/js/7.de312d58.js"><link rel="prefetch" href="/nacos-guide/assets/js/9.4916569b.js">
    <link rel="stylesheet" href="/nacos-guide/assets/css/0.styles.315a301c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nacos-guide/" class="home-link router-link-active"><!----> <span class="site-name">Nacos Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2.x源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2.x源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基于Nacos2.1.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nacos-guide/nacos2/第1节.Nacos源码开篇及环境搭建/第1节.Nacos源码开篇及环境搭建.html" class="sidebar-link">第1节.Nacos源码开篇及环境搭建</a></li><li><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html" class="active sidebar-link">第2节.Nacos客户端服务注册源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#一、服务注册信息示例" class="sidebar-link">一、服务注册信息示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#_1、示例代码" class="sidebar-link">1、示例代码</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#_2、nacos-server连接信息" class="sidebar-link">2、Nacos Server连接信息</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#_3、实例信息" class="sidebar-link">3、实例信息</a></li></ul></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#二、核心namingservice接口" class="sidebar-link">二、核心NamingService接口</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#三、nacosnamingservice的实现" class="sidebar-link">三、NacosNamingService的实现</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#四、namingclientproxydelegate中实现" class="sidebar-link">四、NamingClientProxyDelegate中实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#_1、naminggrpcclientproxy中实现" class="sidebar-link">1、NamingGrpcClientProxy中实现</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#_2、naminghttpclientproxy中实现" class="sidebar-link">2、NamingHttpClientProxy中实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html#六、总结流程" class="sidebar-link">六、总结流程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第2节-nacos客户端服务注册源码分析"><a href="#第2节-nacos客户端服务注册源码分析" class="header-anchor">#</a> 第2节.Nacos客户端服务注册源码分析</h1> <h2 id="一、服务注册信息示例"><a href="#一、服务注册信息示例" class="header-anchor">#</a> 一、服务注册信息示例</h2> <h3 id="_1、示例代码"><a href="#_1、示例代码" class="header-anchor">#</a> 1、示例代码</h3> <p>针对Nacos2.1版本，我们先从Nacos-Client开始说起，那么说到客户端就涉及到服务注册，我们先了解一下Nacos客户端都会将什么信息传递给服务器，我们直接从Nacos Client项目的NamingTest说起:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NamingTest</span> <span class="token punctuation">{</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testServiceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//声明属性信息</span>
    <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">PropertyKeyConst</span><span class="token punctuation">.</span>SERVER_ADDR<span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:8848&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">PropertyKeyConst</span><span class="token punctuation">.</span>USERNAME<span class="token punctuation">,</span> <span class="token string">&quot;nacos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">PropertyKeyConst</span><span class="token punctuation">.</span>PASSWORD<span class="token punctuation">,</span> <span class="token string">&quot;nacos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//声明实例信息</span>
    <span class="token class-name">Instance</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span><span class="token string">&quot;1.1.1.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;netType&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;external&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;version&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span><span class="token function">setMetadata</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//获得服务接口</span>
    <span class="token class-name">NamingService</span> namingService <span class="token operator">=</span> <span class="token class-name">NacosFactory</span><span class="token punctuation">.</span><span class="token function">createNamingService</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//注册实例</span>
    namingService<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token string">&quot;nacos.test.1&quot;</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//睡眠5S</span>
    <span class="token class-name">ThreadUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询所有实例</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> namingService<span class="token punctuation">.</span><span class="token function">getAllInstances</span><span class="token punctuation">(</span><span class="token string">&quot;nacos.test.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        ExpressionSelector expressionSelector = new ExpressionSelector();</span>
    <span class="token comment">//        expressionSelector.setExpression(&quot;INSTANCE.metadata.registerSource = 'dubbo'&quot;);</span>
    <span class="token comment">//        ListView&lt;String&gt; serviceList = namingService.getServicesOfServer(1, 10, expressionSelector);</span>
    
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实这就是客户端注册的一个测试类，它模仿了一个真实的服务注册进Nacos的过程，包括NacosServer连接、实例的创建、实例属性的赋值、注册实例，所以在这个其中包含了服务注册的核心代码，仅从此处的代码分析，可以看出，Nacos注册服务实例时，包含了两大类信息：Nacos Server连接信息和实例信息。</p> <h3 id="_2、nacos-server连接信息"><a href="#_2、nacos-server连接信息" class="header-anchor">#</a> 2、Nacos Server连接信息</h3> <p>Nacos Server连接信息，存储在Properties当中，包含以下信息：</p> <ul><li>Server地址：Nacos服务器地址，属性的key为serverAddr；</li> <li>用户名：连接Nacos服务的用户名，属性key为username，默认值为nacos；</li> <li>密码：连接Nacos服务的密码，属性key为password，默认值为nacos；</li></ul> <h3 id="_3、实例信息"><a href="#_3、实例信息" class="header-anchor">#</a> 3、实例信息</h3> <p>注册实例信息用Instance对象承载，注册的实例信息又分两部分：实例基础信息和元数据。</p> <p><strong>实例基础信息包括</strong>：</p> <ul><li>instanceId：实例的唯一ID；</li> <li>ip：实例IP，提供给消费者进行通信的地址；</li> <li>port： 端口，提供给消费者访问的端口；</li> <li>weight：权重，当前实例的权限，浮点类型（默认1.0D）；</li> <li>healthy：健康状况，默认true；</li> <li>enabled：实例是否准备好接收请求，默认true；</li> <li>ephemeral：实例是否为瞬时的，默认为true；</li> <li>clusterName：实例所属的集群名称；</li> <li>serviceName：实例的服务信息；</li></ul> <p>Instance类包含了实例的基础信息之外，还包含了用于<strong>存储元数据的metadata</strong>（描述数据的数据），类型为HashMap，从当前这个Demo中我们可以得知存放了两个数据：</p> <ul><li>netType：顾名思义，网络类型，这里的值为external，也就是外网的意思；</li> <li>version：版本，Nacos的版本，这里是2.0这个大版本。</li></ul> <p>除了Demo中这些“自定义”的信息，在Instance类中还定义了一些默认信息，这些信息通过get方法提供：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getInstanceHeartBeatInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getMetaDataByKeyWithDefault</span><span class="token punctuation">(</span><span class="token class-name">PreservedMetadataKeys</span><span class="token punctuation">.</span>HEART_BEAT_INTERVAL<span class="token punctuation">,</span>
                                       <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_HEART_BEAT_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getInstanceHeartBeatTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getMetaDataByKeyWithDefault</span><span class="token punctuation">(</span><span class="token class-name">PreservedMetadataKeys</span><span class="token punctuation">.</span>HEART_BEAT_TIMEOUT<span class="token punctuation">,</span>
                                       <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_HEART_BEAT_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getIpDeleteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getMetaDataByKeyWithDefault</span><span class="token punctuation">(</span><span class="token class-name">PreservedMetadataKeys</span><span class="token punctuation">.</span>IP_DELETE_TIMEOUT<span class="token punctuation">,</span>
                                       <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_IP_DELETE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getInstanceIdGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getMetaDataByKeyWithDefault</span><span class="token punctuation">(</span><span class="token class-name">PreservedMetadataKeys</span><span class="token punctuation">.</span>INSTANCE_ID_GENERATOR<span class="token punctuation">,</span>
                                       <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_INSTANCE_ID_GENERATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的get方法在需要元数据默认值时会被用到：</p> <ul><li>preserved.heart.beat.interval：心跳间隙的key，默认为5s，也就是默认5秒进行一次心跳；</li> <li>preserved.heart.beat.timeout：心跳超时的key，默认为15s，也就是默认15秒收不到心跳，实例将会标记为不健康；</li> <li>preserved.ip.delete.timeout：实例IP被删除的key，默认为30s，也就是30秒收不到心跳，实例将会被移除；</li> <li>preserved.instance.id.generator：实例ID生成器key，默认为simple；</li></ul> <p>这些都是Nacos默认提供的值，也就是当前实例注册时会告诉Nacos Server说：我的心跳间隙、心跳超时等对应的值是多少，你按照这个值来判断我这个实例是否健康。</p> <p>有了这些信息，我们基本是已经知道注册实例时需要传递什么参数，需要配置什么参数了。</p> <h2 id="二、核心namingservice接口"><a href="#二、核心namingservice接口" class="header-anchor">#</a> 二、核心NamingService接口</h2> <p>​	NamingService接口是Nacos命名服务对外提供的一个统一接口，看对应的源码就可以发现，它提供了大量实例相关的接口方法：</p> <ul><li><p>服务实例注册</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>服务实例注销</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">deregisterInstance</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>获取服务实例列表</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllInstances</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>查询健康服务实例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectInstances</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>查询集群中健康的服务实例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectInstances</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>List<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clusters<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用负载均衡策略选择一个健康的服务实例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Instance</span> <span class="token function">selectOneHealthyInstance</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>订阅服务事件</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>取消订阅服务事件</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>获取所有（或指定）服务名称</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ListView</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServicesOfServer</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>获取所有订阅的服务</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSubscribeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>获取Nacos服务的状态</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token function">getServerStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>主动关闭服务</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">shutDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span>
</code></pre></div></li></ul> <p>在这些方法中提供了大量的重载方法，应用于不同场景和不同类型实例或服务的筛选，所以我们只需要在不同的情况下使用不同的方法即可。</p> <p>NamingService的实例化是通过NamingFactory类和上面的Nacos服务信息，从代码中可以看出这里采用了反射机制来实例化NamingService，具体的实现类为NacosNamingService：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NamingService</span> <span class="token function">createNamingService</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> driverImplClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;com.alibaba.nacos.client.naming.NacosNamingService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> driverImplClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">Properties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">NamingService</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>CLIENT_INVALID_PARAM<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、nacosnamingservice的实现"><a href="#三、nacosnamingservice的实现" class="header-anchor">#</a> 三、NacosNamingService的实现</h2> <p>在示例代码中使用了NamingService的registerInstance方法来进行服务实例的注册，该方法接收两个参数，服务名称和实例对象。这个方法的最大作用是设置了当前实例的分组信息。我们知道，在Nacos中，通过Namespace、group、Service、Cluster等一层层的将实例进行环境的隔离。在这里设置了默认的分组为“DEFAULT_GROUP”。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token function">registerInstance</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_GROUP<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>紧接着调用的registerInstance方法如下，这个方法实现了两个功能：</p> <p>​	第一，检查心跳时间设置的对不对（心跳默认为5秒）</p> <p>​	第二，通过NamingClientProxy这个代理来执行服务注册操作</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">checkInstanceIsLegal</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查心跳</span>
    clientProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过代理执行服务注册操作</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过clientProxy我们发现NamingClientProxy这个代理接口的具体实现是有NamingClientProxyDelegate来完成的，这个可以从NacosNamingService构造方法中来看出。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NacosNamingService</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token function">init</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>初始化在init方法中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ValidatorUtils</span><span class="token punctuation">.</span><span class="token function">checkInitParam</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>namespace <span class="token operator">=</span> <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initNamespaceForNaming</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initSerialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InitUtils</span><span class="token punctuation">.</span><span class="token function">initWebRootContext</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLogName</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>changeNotifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstancesChangeNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">registerToPublisher</span><span class="token punctuation">(</span><span class="token class-name">InstancesChangeEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">registerSubscriber</span><span class="token punctuation">(</span>changeNotifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceInfoHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfoHolder</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//在这里进行了初始化，并看出使用的是NamingClientProxyDelegate来完成的</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clientProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingClientProxyDelegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namespace<span class="token punctuation">,</span> serviceInfoHolder<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> changeNotifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="四、namingclientproxydelegate中实现"><a href="#四、namingclientproxydelegate中实现" class="header-anchor">#</a> 四、NamingClientProxyDelegate中实现</h2> <p>根据上方的分析和源码的阅读，我们可以发现NamingClientProxy调用registerService实际上调用的就是NamingClientProxyDelegate的对应方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token function">getExecuteClientProxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>真正调用注册服务的并不是代理实现类，而是根据当前实例是否为瞬时对象，来选择对应的客户端代理来进行请求的：</p> <p>如果当前实例为瞬时对象，则采用gRPC协议（NamingGrpcClientProxy）进行请求，否则采用http协议（NamingHttpClientProxy）进行请求。默认为瞬时对象，也就是说，2.0版本中默认采用了gRPC协议进行与Nacos服务进行交互。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">NamingClientProxy</span> <span class="token function">getExecuteClientProxy</span><span class="token punctuation">(</span><span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> grpcClientProxy <span class="token operator">:</span> httpClientProxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1、naminggrpcclientproxy中实现"><a href="#_1、naminggrpcclientproxy中实现" class="header-anchor">#</a> 1、NamingGrpcClientProxy中实现</h3> <p>从Nacos2.0开始，Nacos增加了关于gRPC协议（NamingGrpcClientProxy）的支持，我们主要关注一下registerService方法实现，这里其实做了两件事情：</p> <ol><li>缓存当前注册的实例信息用于恢复，缓存的数据结构为ConcurrentMap&lt;String, Instance&gt;，key为“serviceName@@groupName”，value就是前面封装的实例信息。</li> <li>另外一件事就是封装了参数，基于gRPC进行服务的调用和结果的处理。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[REGISTER-SERVICE] {} registering service {} with instance {}&quot;</span><span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span>
                       instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redoService<span class="token punctuation">.</span><span class="token function">cacheInstanceForRedo</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//缓存数据</span>
    <span class="token function">doRegisterService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//基于gRPC进行服务的调用</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在注册之前可以看到调用redoService将我们的注册信息在内存中进行缓存。redoService缓存数据后，默认情况下回每隔3s去执行RedoScheduledTask任务，如果发现当前连接处于断开状态，则根据缓存中的数据执行实例重新注册和实例订阅的处理。</p> <p>调用doRegisterService方法执行真正的注册逻辑，通过GRPC请求注册接口，同时调用redoService类，标记缓存中的数据为当前信息已经注册过。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Execute register operation.
 *
 * @param serviceName name of service
 * @param groupName   group of service
 * @param instance    instance to register
 * @throws NacosException nacos exception
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRegisterService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token class-name">InstanceRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstanceRequest</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span>
            <span class="token class-name">NamingRemoteConstants</span><span class="token punctuation">.</span>REGISTER_INSTANCE<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestToServer</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redoService<span class="token punctuation">.</span><span class="token function">instanceRegistered</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2、naminghttpclientproxy中实现"><a href="#_2、naminghttpclientproxy中实现" class="header-anchor">#</a> 2、NamingHttpClientProxy中实现</h3> <p>在Nacos2.0以前，是通过HTTP的方式完成服务的注册，注册代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    
    NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[REGISTER-SERVICE] {} registering service {} with instance: {}&quot;</span><span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span>
            instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> groupedServiceName <span class="token operator">=</span> <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 如果是临时实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeatInfo</span> beatInfo <span class="token operator">=</span> beatReactor<span class="token punctuation">.</span><span class="token function">buildBeatInfo</span><span class="token punctuation">(</span>groupedServiceName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beatReactor<span class="token punctuation">.</span><span class="token function">addBeatInfo</span><span class="token punctuation">(</span>groupedServiceName<span class="token punctuation">,</span> beatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">//构造注册参数</span>
    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span>NAMESPACE_ID<span class="token punctuation">,</span> namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span>SERVICE_NAME<span class="token punctuation">,</span> groupedServiceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span>GROUP_NAME<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span>CLUSTER_NAME<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>IP_PARAM<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>PORT_PARAM<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>WEIGHT_PARAM<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>REGISTER_ENABLE_PARAM<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>HEALTHY_PARAM<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>EPHEMERAL_PARAM<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>META_PARAM<span class="token punctuation">,</span> <span class="token class-name">JacksonUtils</span><span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用核心请求API</span>
    <span class="token function">reqApi</span><span class="token punctuation">(</span><span class="token class-name">UtilAndComs</span><span class="token punctuation">.</span>nacosUrlInstance<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>对于HTTP方式来说，核心的reqApi是我们需要关注的内容，并且知道了，他向服务端发起了心跳检测任务请求和注册请求2中逻辑。HTTP方式的注册请求代码如下，核心关注的就是他进行了Nacos的域名解析与随机负载请求代码处理：</p> <p>如果当前支持域名方式的处理，则根据重试的次数请求，直到成功，且达到重试次数。</p> <p>如果当前不是服务域名方式的处理，则根据服务的数量进行随机轮训请求，直到请求成功，且服务器轮训结束。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">reqApi</span><span class="token punctuation">(</span><span class="token class-name">String</span> api<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> body<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span>
        <span class="token class-name">String</span> method<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span>NAMESPACE_ID<span class="token punctuation">,</span> <span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>serverListManager<span class="token punctuation">.</span><span class="token function">isDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>INVALID_PARAM<span class="token punctuation">,</span> <span class="token string">&quot;no server available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token class-name">NacosException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serverListManager<span class="token punctuation">.</span><span class="token function">isDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> nacosDomain <span class="token operator">=</span> serverListManager<span class="token punctuation">.</span><span class="token function">getNacosDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetry<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> nacosDomain<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exception <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;request {} failed.&quot;</span><span class="token punctuation">,</span> nacosDomain<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> server <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> server<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exception <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;request {} failed.&quot;</span><span class="token punctuation">,</span> server<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            index <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//忽略错误日志代码</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="六、总结流程"><a href="#六、总结流程" class="header-anchor">#</a> 六、总结流程</h2> <p>通过本文的分析，可以清晰的的直到，对于Nacos客户端注册来说，涉及到的核心关键点如下：</p> <p>1、Nacos多种通信方式的处理（GRPC or HTTP）</p> <p>2、GRPC通信时的RedoService缓存数据，任务重做业务处理</p> <p>3、HTTP通信时的向服务端发现心跳任务请求的处理</p> <p>4、通信时采用的委派设计模式的应用等</p> <p>流程图如下:<img src="/nacos-guide/assets/img/zc.9f9fcdc2.png" alt="zc"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nacos-guide/nacos2/第1节.Nacos源码开篇及环境搭建/第1节.Nacos源码开篇及环境搭建.html" class="prev">
        第1节.Nacos源码开篇及环境搭建
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nacos-guide/assets/js/app.66cd9b59.js" defer></script><script src="/nacos-guide/assets/js/2.fd0c06d4.js" defer></script><script src="/nacos-guide/assets/js/8.6c4ec18c.js" defer></script>
  </body>
</html>

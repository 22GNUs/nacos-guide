<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第8节.Nacos服务端服务健康检查源码分析 | Nacos Guide</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="分享微服务组件Nacos，学习其源码与思想">
    
    <link rel="preload" href="/nacos-guide/assets/css/0.styles.315a301c.css" as="style"><link rel="preload" href="/nacos-guide/assets/js/app.4a8112d9.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/2.fd0c06d4.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/37.f763ea1a.js" as="script"><link rel="prefetch" href="/nacos-guide/assets/js/10.79b0461e.js"><link rel="prefetch" href="/nacos-guide/assets/js/11.e5dec651.js"><link rel="prefetch" href="/nacos-guide/assets/js/12.2e5c3425.js"><link rel="prefetch" href="/nacos-guide/assets/js/13.83dcdc6b.js"><link rel="prefetch" href="/nacos-guide/assets/js/14.09e39f44.js"><link rel="prefetch" href="/nacos-guide/assets/js/15.fc84e696.js"><link rel="prefetch" href="/nacos-guide/assets/js/16.1fb51669.js"><link rel="prefetch" href="/nacos-guide/assets/js/17.856ec3c7.js"><link rel="prefetch" href="/nacos-guide/assets/js/18.3df1ffb4.js"><link rel="prefetch" href="/nacos-guide/assets/js/19.e0802aa6.js"><link rel="prefetch" href="/nacos-guide/assets/js/20.f382b739.js"><link rel="prefetch" href="/nacos-guide/assets/js/21.ded4a804.js"><link rel="prefetch" href="/nacos-guide/assets/js/22.49057772.js"><link rel="prefetch" href="/nacos-guide/assets/js/23.1821f9c8.js"><link rel="prefetch" href="/nacos-guide/assets/js/24.d449e7ba.js"><link rel="prefetch" href="/nacos-guide/assets/js/25.977e391a.js"><link rel="prefetch" href="/nacos-guide/assets/js/26.744a778e.js"><link rel="prefetch" href="/nacos-guide/assets/js/27.0c29d398.js"><link rel="prefetch" href="/nacos-guide/assets/js/28.5fd03a42.js"><link rel="prefetch" href="/nacos-guide/assets/js/29.453105e6.js"><link rel="prefetch" href="/nacos-guide/assets/js/3.456aee76.js"><link rel="prefetch" href="/nacos-guide/assets/js/30.aeef2fc3.js"><link rel="prefetch" href="/nacos-guide/assets/js/31.531f13fc.js"><link rel="prefetch" href="/nacos-guide/assets/js/32.0009000b.js"><link rel="prefetch" href="/nacos-guide/assets/js/33.2c5dac3a.js"><link rel="prefetch" href="/nacos-guide/assets/js/34.63304a41.js"><link rel="prefetch" href="/nacos-guide/assets/js/35.b4f3bfbd.js"><link rel="prefetch" href="/nacos-guide/assets/js/36.13f8396a.js"><link rel="prefetch" href="/nacos-guide/assets/js/38.ebca670b.js"><link rel="prefetch" href="/nacos-guide/assets/js/39.aa88fa3f.js"><link rel="prefetch" href="/nacos-guide/assets/js/4.7958c833.js"><link rel="prefetch" href="/nacos-guide/assets/js/5.c131b314.js"><link rel="prefetch" href="/nacos-guide/assets/js/6.af062ec9.js"><link rel="prefetch" href="/nacos-guide/assets/js/7.da76f27c.js"><link rel="prefetch" href="/nacos-guide/assets/js/8.b0f12c6f.js"><link rel="prefetch" href="/nacos-guide/assets/js/9.4916569b.js">
    <link rel="stylesheet" href="/nacos-guide/assets/css/0.styles.315a301c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nacos-guide/" class="home-link router-link-active"><!----> <span class="site-name">Nacos Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基于Nacos2.1.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nacos-guide/nacos2/第1节.Nacos源码开篇及环境搭建/第1节.Nacos源码开篇及环境搭建.html" class="sidebar-link">第1节.Nacos源码开篇及环境搭建</a></li><li><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html" class="sidebar-link">第2节.Nacos客户端服务注册源码分析</a></li><li><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html" class="sidebar-link">第3节.Nacos服务端服务注册之基本处理流程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第8节-nacos服务端服务健康检查源码分析"><a href="#第8节-nacos服务端服务健康检查源码分析" class="header-anchor">#</a> 第8节.Nacos服务端服务健康检查源码分析</h1> <p>对于健康检查来说，要从客户端的请求模型说起。</p> <h2 id="一、客户端请求方式"><a href="#一、客户端请求方式" class="header-anchor">#</a> 一、客户端请求方式</h2> <p>从Nacos2.0开始，支持使用长连接的方式，它指在一个连接上可以连续发送多个<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%8C%85/489739" target="_blank" rel="noopener noreferrer">数据包<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在连接保持期间，如果没有数据包发送，需要双方发链路检测包。注册中心客户端2.0之后使用gRPC代替http，会与服务端建立长连接，但仍然保留了对旧http客户端的支持。</p> <p>其中，<strong>NamingClientProxy</strong>接口负责底层通讯，调用服务端接口。有三个实现类：</p> <ul><li><strong>NamingClientProxyDelegate</strong>：代理类，对所有NacosNamingService中的方法进行<strong>代理</strong>，根据实际情况选择http或gRPC协议请求服务端。</li> <li><strong>NamingGrpcClientProxy</strong>：底层通讯基于gRPC长连接。</li> <li><strong>NamingHttpClientProxy</strong>：底层通讯基于http短连接。使用的都是老代码基本没改，原来1.0NamingProxy重命名过来的。</li></ul> <p>以客户端<strong>服务注册</strong>为例，<strong>NamingClientProxyDelegate</strong>代理了registerService方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// NacosNamingService.java</span>
<span class="token keyword">private</span> <span class="token class-name">NamingClientProxy</span> clientProxy<span class="token punctuation">;</span> <span class="token comment">// NamingClientProxyDelegate</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">checkInstanceIsLegal</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    clientProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>NamingClientProxyDelegate会<strong>根据instance实例是否是临时节点而选择不同的协议</strong>。</p> <p>​	临时instance：gRPC</p> <p>​	持久instance：http</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NamingClientProxyDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">NamingClientProxy</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">NamingHttpClientProxy</span> httpClientProxy<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">NamingGrpcClientProxy</span> grpcClientProxy<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerService</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
      <span class="token function">getExecuteClientProxy</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// 临时节点，走grpc长连接；持久节点，走http短连接</span>
  <span class="token keyword">private</span> <span class="token class-name">NamingClientProxy</span> <span class="token function">getExecuteClientProxy</span><span class="token punctuation">(</span><span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> grpcClientProxy <span class="token operator">:</span> httpClientProxy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>很重的知识点：Nacos2.x以后，临时实例使用GRPC的方式调用服务端接口，持久化实例使用HTTP方式调用服务端接口。</strong></p> <p><strong>很重的知识点：Nacos2.x以后，临时实例使用GRPC的方式调用服务端接口，持久化实例使用HTTP方式调用服务端接口。</strong></p> <h2 id="二、2-x版本grpc临时实例服务端处理"><a href="#二、2-x版本grpc临时实例服务端处理" class="header-anchor">#</a> 二、2.x版本GRPC临时实例服务端处理</h2> <p>在之前的1.x版本中临时实例走Distro协议内存存储，客户端向注册中心发送心跳来维持自身healthy状态，持久实例走Raft协议持久化存储，服务端定时与客户端建立tcp连接做健康检查。</p> <p>但是2.0版本以后持久化实例没有什么变化，但是2.0临时实例不在使用心跳，而是通过长连接是否存活来判断实例是否健康。</p> <p><strong>ConnectionManager</strong>负责管理所有客户端的长连接。</p> <p><strong>每3s</strong>检测所有超过<strong>20s没发生过通讯</strong>的客户端，向客户端发起<strong>ClientDetectionRequest探测请求</strong>，如果客户端在<strong>1s内成功响应，则检测通过</strong>，否则执行unregister方法移除Connection。</p> <p><strong>如果客户端持续与服务端通讯，服务端是不需要主动探活的</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 启动不健康连接排除功能.</span>
    <span class="token class-name">RpcScheduledExecutor</span><span class="token punctuation">.</span>COMMON_SERVER_EXECUTOR<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                <span class="token keyword">int</span> totalCount <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Connection check task start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getLongConnectionMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>totalCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//统计过时（20s）连接</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> currentSdkClientCount <span class="token operator">=</span> <span class="token function">currentSdkClientCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> isLoaderClient <span class="token operator">=</span> loadClient <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> currentMaxClient <span class="token operator">=</span> isLoaderClient <span class="token operator">?</span> loadClient <span class="token operator">:</span> connectionLimitRule<span class="token punctuation">.</span>countLimit<span class="token punctuation">;</span>
                <span class="token keyword">int</span> expelCount <span class="token operator">=</span> currentMaxClient <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>currentSdkClientCount <span class="token operator">-</span> currentMaxClient<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                    <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Total count ={}, sdkCount={},clusterCount={}, currentLimit={}, toExpelCount={}&quot;</span><span class="token punctuation">,</span>
                          totalCount<span class="token punctuation">,</span> currentSdkClientCount<span class="token punctuation">,</span> <span class="token punctuation">(</span>totalCount <span class="token operator">-</span> currentSdkClientCount<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          currentMaxClient <span class="token operator">+</span> <span class="token punctuation">(</span>isLoaderClient <span class="token operator">?</span> <span class="token string">&quot;(loaderCount)&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expelCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> expelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">&gt;</span></span> expelForIp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//1. calculate expel count  of ip.</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token class-name">Connection</span> client <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> appName <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> clientIp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSdkSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>expelForIp<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//get limit for current ip.</span>
                        <span class="token keyword">int</span> countLimitOfIp <span class="token operator">=</span> connectionLimitRule<span class="token punctuation">.</span><span class="token function">getCountLimitOfIp</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>countLimitOfIp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">int</span> countLimitOfApp <span class="token operator">=</span> connectionLimitRule<span class="token punctuation">.</span><span class="token function">getCountLimitOfApp</span><span class="token punctuation">(</span>appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            countLimitOfIp <span class="token operator">=</span> countLimitOfApp <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> countLimitOfIp <span class="token operator">:</span> countLimitOfApp<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>countLimitOfIp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            countLimitOfIp <span class="token operator">=</span> connectionLimitRule<span class="token punctuation">.</span><span class="token function">getCountLimitPerClientIpDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>countLimitOfIp <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> connectionForClientIp<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">AtomicInteger</span> currentCountIp <span class="token operator">=</span> connectionForClientIp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentCountIp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> currentCountIp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> countLimitOfIp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                expelForIp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span>currentCountIp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> countLimitOfIp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                    <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Check over limit for ip limit rule, over limit ip count={}&quot;</span><span class="token punctuation">,</span> expelForIp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>expelForIp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Over limit ip expel info, {}&quot;</span><span class="token punctuation">,</span> expelForIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> outDatedConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//2.get expel connection for ip limit.</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Connection</span> client <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> clientIp <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">AtomicInteger</span> integer <span class="token operator">=</span> expelForIp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>integer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> integer<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        integer<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        expelClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        expelCount<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastActiveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> KEEP_ALIVE_TIME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        outDatedConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>

                <span class="token comment">//3. if total count is still over limit.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>expelCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Connection</span> client <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expelForIp<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clientIp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">isSdkSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> expelCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            expelClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            expelCount<span class="token operator">--</span><span class="token punctuation">;</span>
                            outDatedConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">String</span> serverIp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> serverPort <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redirectAddress<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> redirectAddress<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>COLON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> redirectAddress<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>COLON<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    serverIp <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    serverPort <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> expelledClientId <span class="token operator">:</span> expelClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span>expelledClientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ConnectResetRequest</span> connectResetRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectResetRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            connectResetRequest<span class="token punctuation">.</span><span class="token function">setServerIp</span><span class="token punctuation">(</span>serverIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            connectResetRequest<span class="token punctuation">.</span><span class="token function">setServerPort</span><span class="token punctuation">(</span>serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            connection<span class="token punctuation">.</span><span class="token function">asyncRequest</span><span class="token punctuation">(</span>connectResetRequest<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                                <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Send connection reset request , connection id = {},recommendServerIp={}, recommendServerPort={}&quot;</span><span class="token punctuation">,</span>
                                      expelledClientId<span class="token punctuation">,</span> connectResetRequest<span class="token punctuation">.</span><span class="token function">getServerIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                      connectResetRequest<span class="token punctuation">.</span><span class="token function">getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionAlreadyClosedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">unregister</span><span class="token punctuation">(</span>expelledClientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurs when expel connection, expelledClientId:{}&quot;</span><span class="token punctuation">,</span> expelledClientId<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//4.client active detection.</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Out dated connection ,size={}&quot;</span><span class="token punctuation">,</span> outDatedConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//异步请求所有需要检测的连接</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>outDatedConnections<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> successConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>outDatedConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> outDateConnectionId <span class="token operator">:</span> outDatedConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token function">getConnection</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token class-name">ClientDetectionRequest</span> clientDetectionRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientDetectionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                connection<span class="token punctuation">.</span><span class="token function">asyncRequest</span><span class="token punctuation">(</span>clientDetectionRequest<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token keyword">return</span> <span class="token number">1000L</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                            connection<span class="token punctuation">.</span><span class="token function">freshActiveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            successConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token punctuation">}</span>

                                    <span class="token annotation punctuation">@Override</span>
                                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                                    <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]send connection active request &quot;</span><span class="token punctuation">,</span> outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionAlreadyClosedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                                <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]Error occurs when check client active detection ,error={}&quot;</span><span class="token punctuation">,</span>
                                       outDateConnectionId<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">3000L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                        <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Out dated connection check successCount={}&quot;</span><span class="token punctuation">,</span> successConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 对于没有成功响应的客户端，执行unregister移出</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> outDateConnectionId <span class="token operator">:</span> outDatedConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>successConnections<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST
                                <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]Unregister Out dated connection....&quot;</span><span class="token punctuation">,</span> outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">unregister</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//reset loader client</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoaderClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    loadClient <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    redirectAddress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Connection check task end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurs during connection check... &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">,</span> <span class="token number">3000L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">//注销（移出）连接方法</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">unregister</span><span class="token punctuation">(</span><span class="token class-name">String</span> connectionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Connection</span> remove <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remove <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> clientIp <span class="token operator">=</span> remove<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clientIp<span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> connectionForClientIp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>atomicInteger <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectionForClientIp<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        remove<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE_DIGEST<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]Connection unregistered successfully. &quot;</span><span class="token punctuation">,</span> connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientConnectionEventListenerRegistry<span class="token punctuation">.</span><span class="token function">notifyClientDisConnected</span><span class="token punctuation">(</span>remove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>移除connection后，继承ClientConnectionEventListener的<strong>ConnectionBasedClientManager</strong>会移除Client，发布<strong>ClientDisconnectEvent事件</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">clientDisconnected</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>SRV_LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Client connection {} disconnect, remove instances and subscribers&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConnectionBasedClient</span> client <span class="token operator">=</span> clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientDisconnectEvent</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ClientDisconnectEvent会触发几个事件：</p> <p><strong>1）Distro协议</strong>：同步移除的client数据</p> <p><strong>2）清除两个索引缓存</strong>：ClientServiceIndexesManager中Service与发布Client的关系；ServiceStorage中Service与Instance的关系</p> <p><strong>3）服务订阅</strong>：ClientDisconnectEvent会<strong>间接触发ServiceChangedEvent事件</strong>，将服务变更通知客户端。</p> <h2 id="三、1-x版本http临时实例处理"><a href="#三、1-x版本http临时实例处理" class="header-anchor">#</a> 三、1.x版本HTTP临时实例处理</h2> <h3 id="_3-1、1-x版本客户端http方式发起心跳"><a href="#_3-1、1-x版本客户端http方式发起心跳" class="header-anchor">#</a> 3.1、1.x版本客户端HTTP方式发起心跳</h3> <p>临时实例。调用</p> <h3 id="_3-2、1-x版本服务端更新心跳信息"><a href="#_3-2、1-x版本服务端更新心跳信息" class="header-anchor">#</a> 3.2、1.x版本服务端更新心跳信息</h3> <p>sendbeat接口</p> <h3 id="_3-3、1-x版本服务端服务心跳健康检查任务"><a href="#_3-3、1-x版本服务端服务心跳健康检查任务" class="header-anchor">#</a> 3.3、1.x版本服务端服务心跳健康检查任务</h3></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/23/2022, 3:22:32 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/nacos-guide/assets/js/app.4a8112d9.js" defer></script><script src="/nacos-guide/assets/js/2.fd0c06d4.js" defer></script><script src="/nacos-guide/assets/js/37.f763ea1a.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第4节.Nacos服务端服务注册之Distro协议集群注册同步与异步复制 | Nacos Guide</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="分享微服务组件Nacos，学习其源码与思想">
    
    <link rel="preload" href="/nacos-guide/assets/css/0.styles.8ec0511f.css" as="style"><link rel="preload" href="/nacos-guide/assets/js/app.58904bbc.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/2.bcb8ada0.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/36.1b19578b.js" as="script"><link rel="prefetch" href="/nacos-guide/assets/js/10.414297eb.js"><link rel="prefetch" href="/nacos-guide/assets/js/11.6924b8be.js"><link rel="prefetch" href="/nacos-guide/assets/js/12.2df7aaf5.js"><link rel="prefetch" href="/nacos-guide/assets/js/13.0411f054.js"><link rel="prefetch" href="/nacos-guide/assets/js/14.2fece716.js"><link rel="prefetch" href="/nacos-guide/assets/js/15.a9af88a3.js"><link rel="prefetch" href="/nacos-guide/assets/js/16.ac6f0f62.js"><link rel="prefetch" href="/nacos-guide/assets/js/17.c9e55614.js"><link rel="prefetch" href="/nacos-guide/assets/js/18.07efd751.js"><link rel="prefetch" href="/nacos-guide/assets/js/19.d1a4fa8c.js"><link rel="prefetch" href="/nacos-guide/assets/js/20.94547e75.js"><link rel="prefetch" href="/nacos-guide/assets/js/21.8bbc968e.js"><link rel="prefetch" href="/nacos-guide/assets/js/22.34426fff.js"><link rel="prefetch" href="/nacos-guide/assets/js/23.f5a0dd50.js"><link rel="prefetch" href="/nacos-guide/assets/js/24.8e6edd5b.js"><link rel="prefetch" href="/nacos-guide/assets/js/25.4205587a.js"><link rel="prefetch" href="/nacos-guide/assets/js/26.54e0dcb1.js"><link rel="prefetch" href="/nacos-guide/assets/js/27.f0b99844.js"><link rel="prefetch" href="/nacos-guide/assets/js/28.d3ff820c.js"><link rel="prefetch" href="/nacos-guide/assets/js/29.1cea8961.js"><link rel="prefetch" href="/nacos-guide/assets/js/3.21236339.js"><link rel="prefetch" href="/nacos-guide/assets/js/30.56bea7be.js"><link rel="prefetch" href="/nacos-guide/assets/js/31.b0a7ef5d.js"><link rel="prefetch" href="/nacos-guide/assets/js/32.0f78403e.js"><link rel="prefetch" href="/nacos-guide/assets/js/33.3e6f607f.js"><link rel="prefetch" href="/nacos-guide/assets/js/34.e7a2db63.js"><link rel="prefetch" href="/nacos-guide/assets/js/35.fcbdc28b.js"><link rel="prefetch" href="/nacos-guide/assets/js/37.523f4f68.js"><link rel="prefetch" href="/nacos-guide/assets/js/38.11c91ed1.js"><link rel="prefetch" href="/nacos-guide/assets/js/39.6ae2d483.js"><link rel="prefetch" href="/nacos-guide/assets/js/4.1e55e07a.js"><link rel="prefetch" href="/nacos-guide/assets/js/40.e64072b0.js"><link rel="prefetch" href="/nacos-guide/assets/js/41.d8f71396.js"><link rel="prefetch" href="/nacos-guide/assets/js/42.a36a8c1a.js"><link rel="prefetch" href="/nacos-guide/assets/js/43.2a859251.js"><link rel="prefetch" href="/nacos-guide/assets/js/44.da8dce44.js"><link rel="prefetch" href="/nacos-guide/assets/js/45.b4f19581.js"><link rel="prefetch" href="/nacos-guide/assets/js/46.f77b8d13.js"><link rel="prefetch" href="/nacos-guide/assets/js/47.2c838d77.js"><link rel="prefetch" href="/nacos-guide/assets/js/48.fe38d9dc.js"><link rel="prefetch" href="/nacos-guide/assets/js/5.86974e91.js"><link rel="prefetch" href="/nacos-guide/assets/js/6.cbe62e54.js"><link rel="prefetch" href="/nacos-guide/assets/js/7.46bb4735.js"><link rel="prefetch" href="/nacos-guide/assets/js/8.d72cc739.js"><link rel="prefetch" href="/nacos-guide/assets/js/9.dbce594a.js">
    <link rel="stylesheet" href="/nacos-guide/assets/css/0.styles.8ec0511f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nacos-guide/" class="home-link router-link-active"><!----> <span class="site-name">Nacos Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/pattern/" class="nav-link">
  Nacos设计模式
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/pattern/" class="nav-link">
  Nacos设计模式
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基于Nacos2.1.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nacos-guide/nacos2/第1节.Nacos源码开篇及环境搭建/第1节.Nacos源码开篇及环境搭建.html" class="sidebar-link">第1节.Nacos源码开篇及环境搭建</a></li><li><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html" class="sidebar-link">第2节.Nacos客户端服务注册源码分析</a></li><li><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html" class="sidebar-link">第3节.服务端服务注册之基本处理流程</a></li><li><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html" class="active sidebar-link">第4节.服务端服务注册之Distro协议注册与异步复制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html#一、v1版本的http方式" class="sidebar-link">一、V1版本的HTTP方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html#_1-1、当前负责节点发送distro请求源码" class="sidebar-link">1.1、当前负责节点发送Distro请求源码</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html#_1-2、其他非负责节点接收distro复制请求源码" class="sidebar-link">1.2、其他非负责节点接收Distro复制请求源码</a></li></ul></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html#二、v2版本的grpc方式" class="sidebar-link">二、V2版本的GRPC方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html#_2-1、当前负责节点发送distro请求源码" class="sidebar-link">2.1、当前负责节点发送Distro请求源码</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html#_2-2、其他非负责节点接收distro负责请求源码" class="sidebar-link">2.2、其他非负责节点接收Distro负责请求源码</a></li></ul></li></ul></li><li><a href="/nacos-guide/nacos2/第5节.Nacos中的DistroFilter服务注册路由/第5节.Nacos中的DistroFilter服务注册路由.html" class="sidebar-link">第5节.Nacos中的DistroFilter服务注册路由</a></li><li><a href="/nacos-guide/nacos2/第6节.Nacos服务端服务健康检查源码分析/第6节.Nacos服务端服务健康检查源码分析.html" class="sidebar-link">第6节.Nacos服务端服务健康检查源码分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第4节-nacos服务端服务注册之distro协议集群注册同步与异步复制"><a href="#第4节-nacos服务端服务注册之distro协议集群注册同步与异步复制" class="header-anchor">#</a> 第4节.Nacos服务端服务注册之Distro协议集群注册同步与异步复制</h1> <p>Distro协议会在集群之间进行实例数据的同步。V1版本主要采用HTTP的方式。V2版本主要采用GRPC的方式。本篇文章主要介绍基于AP模式下的Nacos的集群之间的数据同步处理。</p> <h2 id="一、v1版本的http方式"><a href="#一、v1版本的http方式" class="header-anchor">#</a> 一、V1版本的HTTP方式</h2> <h3 id="_1-1、当前负责节点发送distro请求源码"><a href="#_1-1、当前负责节点发送distro请求源码" class="header-anchor">#</a> 1.1、当前负责节点发送Distro请求源码</h3> <h4 id="_1-1-1、distro注册信息定义"><a href="#_1-1-1、distro注册信息定义" class="header-anchor">#</a> 1.1.1、Distro注册信息定义</h4> <p>从上一节的梳理中我们知道，在HTTP注册实例的时候，会调用consistencyService.put(key, instances);方法进行一致性协议的处理。</p> <p>对于V2版本来说，在这里会判断当前实例是否为临时实例，如果是临时实例，同时如果是支持GRPC请求，则不执行下方的协议同步处理，执行如下代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token function">onPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If upgrade to 2.0.X, do not sync for v1.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">UpgradeJudgement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUseGrpcFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    distroProtocol<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DistroKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span>INSTANCE_LIST_KEY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DataOperation</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">,</span>
            <span class="token class-name">DistroConfig</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSyncDelayMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果是持久化实例，则执行PersistentServiceProcessor类中的PUT方法，进行基于RAFT的模式同步。</p> <p>对于这块的源码阅读，可以参考Nacos1.4.3的源码实现会比较清晰，V2版本出现了多个子类，可能会影响你的阅读。这里我们忽略是否支持GRPC的判断处理，学习一下V1版本的distroProtocol.sync的业务处理。</p> <p>通过如下代码，可以看到distroProtocol类中的sync方法，排除了当前服务器，向其他服务器发送Distro请求处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sync</span><span class="token punctuation">(</span><span class="token class-name">DistroKey</span> distroKey<span class="token punctuation">,</span> <span class="token class-name">DataOperation</span> action<span class="token punctuation">,</span> <span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Member</span> each <span class="token operator">:</span> memberManager<span class="token punctuation">.</span><span class="token function">allMembersWithoutSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">syncToTarget</span><span class="token punctuation">(</span>distroKey<span class="token punctuation">,</span> action<span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_1-1-2、异步复制task任务与数据复制引擎"><a href="#_1-1-2、异步复制task任务与数据复制引擎" class="header-anchor">#</a> 1.1.2、异步复制Task任务与数据复制引擎</h4> <p>syncToTarget方法内部又调用了NacosDelayTaskExecuteEngine这个核心的任务执行引擎去处理，最终会执行到DistroDelayTaskProcessor类中，进而会调用DistroSyncChangeTask类run方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO-START] {}&quot;</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> type <span class="token operator">=</span> <span class="token function">getDistroKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DistroData</span> distroData <span class="token operator">=</span> distroComponentHolder<span class="token punctuation">.</span><span class="token function">findDataStorage</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDistroData</span><span class="token punctuation">(</span><span class="token function">getDistroKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distroData<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">DataOperation</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> distroComponentHolder<span class="token punctuation">.</span><span class="token function">findTransportAgent</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">syncData</span><span class="token punctuation">(</span>distroData<span class="token punctuation">,</span> <span class="token function">getDistroKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleFailedTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO-END] {} result: {}&quot;</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO] Sync data change failed.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handleFailedTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在HTTP的执行逻辑中，会执行到DistroHttpAgent的syncData方法，从而向其他服务节点发送同步请求。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">syncData</span><span class="token punctuation">(</span><span class="token class-name">DistroData</span> data<span class="token punctuation">,</span> <span class="token class-name">String</span> targetServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memberManager<span class="token punctuation">.</span><span class="token function">hasMember</span><span class="token punctuation">(</span>targetServer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataContent <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">.</span><span class="token function">syncData</span><span class="token punctuation">(</span>dataContent<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getDistroKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于真正执行请求的方法，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">syncData</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span> <span class="token class-name">String</span> curServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderConsts</span><span class="token punctuation">.</span>CLIENT_VERSION_HEADER<span class="token punctuation">,</span> <span class="token class-name">VersionUtils</span><span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderConsts</span><span class="token punctuation">.</span>USER_AGENT_HEADER<span class="token punctuation">,</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>SERVER_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderConsts</span><span class="token punctuation">.</span>ACCEPT_ENCODING<span class="token punctuation">,</span> <span class="token string">&quot;gzip,deflate,sdch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderConsts</span><span class="token punctuation">.</span>CONNECTION<span class="token punctuation">,</span> <span class="token string">&quot;Keep-Alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderConsts</span><span class="token punctuation">.</span>CONTENT_ENCODING<span class="token punctuation">,</span> <span class="token string">&quot;gzip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">RestResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">httpPutLarge</span><span class="token punctuation">(</span>
                <span class="token string">&quot;http://&quot;</span> <span class="token operator">+</span> curServer <span class="token operator">+</span> <span class="token class-name">EnvUtil</span><span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>NACOS_NAMING_CONTEXT
                        <span class="token operator">+</span> DATA_ON_SYNC_URL<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span>HTTP_NOT_MODIFIED <span class="token operator">==</span> result<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to req API:&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;http://&quot;</span> <span class="token operator">+</span> curServer <span class="token operator">+</span> <span class="token class-name">EnvUtil</span><span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>NACOS_NAMING_CONTEXT <span class="token operator">+</span> DATA_ON_SYNC_URL <span class="token operator">+</span> <span class="token string">&quot;. code:&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; msg: &quot;</span>
                <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>SRV_LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;NamingProxy&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到他向其他节点发送了HTTP的distro协议复制请求。地址为：/nacos/v1/ns/distro/datum</p> <h3 id="_1-2、其他非负责节点接收distro复制请求源码"><a href="#_1-2、其他非负责节点接收distro复制请求源码" class="header-anchor">#</a> 1.2、其他非负责节点接收Distro复制请求源码</h3> <p>对于HTTP类型的Distro请求，服务端会先进入到DistroFilter类中进行过滤处理。</p> <p>然后DistroController类会进行接收处理，接口地址为/nacos/v1/ns/distro/datum，源码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/datum&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span> <span class="token function">onSyncDatum</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dataMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[onSync] receive empty entity!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>INVALID_PARAM<span class="token punctuation">,</span> <span class="token string">&quot;receive empty entity!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> dataMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchEphemeralInstanceListKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceManager<span class="token punctuation">.</span><span class="token function">containService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> switchDomain
                    <span class="token punctuation">.</span><span class="token function">isDefaultInstanceEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                serviceManager<span class="token punctuation">.</span><span class="token function">createEmptyService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">DistroHttpData</span> distroHttpData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroHttpData</span><span class="token punctuation">(</span><span class="token function">createDistroKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            distroProtocol<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>distroHttpData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在协议层的接收处理就很简单了，源码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token class-name">DistroData</span> distroData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DistroHttpData</span> distroHttpData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DistroHttpData</span><span class="token punctuation">)</span> distroData<span class="token punctuation">;</span>
    <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span></span> datum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> distroHttpData<span class="token punctuation">.</span><span class="token function">getDeserializedContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">onPut</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> datum<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从源码中可以看到，这个实例的元数据信息存储到了内存的Datum中。相对于负责节点的实例注册，没有了sync的过程。</p> <h2 id="二、v2版本的grpc方式"><a href="#二、v2版本的grpc方式" class="header-anchor">#</a> 二、V2版本的GRPC方式</h2> <p>在Nacos2.x版本中，采用GRPC的方式进行集群实例的Distro协议的同步与复制，并设计了Client模型来完成同步。所以在Nacos2.x中，client可能是真实的实例客户端，也可能是集群中的某一服务节点。</p> <h3 id="_2-1、当前负责节点发送distro请求源码"><a href="#_2-1、当前负责节点发送distro请求源码" class="header-anchor">#</a> 2.1、当前负责节点发送Distro请求源码</h3> <p>在之前服务端的注册逻辑中，代码中调用了client.addServiceInstance(singleton, instanceInfo)代码，当前是AP模型的情况下，在Nacos中是将服务信息放入到了client和ServiceManager中。核心是派发了ClientChangedEvent事件：</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientChangedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后会异步的将注册的服务信息同步和集群其他节点，而这个事件的处理在<code>DistroClientDataProcessor</code>，当前节点作为客户端给其他节点服务器发送Distro数据，核心代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">EnvUtil</span><span class="token punctuation">.</span><span class="token function">getStandaloneMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>upgradeJudgement<span class="token punctuation">.</span><span class="token function">isUseGrpcFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientVerifyFailedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">syncToVerifyFailedServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientVerifyFailedEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">syncToAllServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClientEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">syncToAllServer</span><span class="token punctuation">(</span><span class="token class-name">ClientEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Client</span> client <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Only ephemeral data sync by Distro, persist client should sync by raft.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> client <span class="token operator">||</span> <span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>clientManager<span class="token punctuation">.</span><span class="token function">isResponsibleClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientDisconnectEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DistroKey</span> distroKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroKey</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            distroProtocol<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>distroKey<span class="token punctuation">,</span> <span class="token class-name">DataOperation</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientChangedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DistroKey</span> distroKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroKey</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">//核心代码逻辑 调用统一的distro的sync方法</span>
            distroProtocol<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>distroKey<span class="token punctuation">,</span> <span class="token class-name">DataOperation</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-1-1、异步复制task任务与数据复制引擎"><a href="#_2-1-1、异步复制task任务与数据复制引擎" class="header-anchor">#</a> 2.1.1、异步复制Task任务与数据复制引擎</h4> <p>在V2版本的代码中， distroProtocol.sync的数据同步任务，会触发DelayTaskExecuteEngine任务异步复制引擎，去同步数据，代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">syncToTarget</span><span class="token punctuation">(</span><span class="token class-name">DistroKey</span> distroKey<span class="token punctuation">,</span> <span class="token class-name">DataOperation</span> action<span class="token punctuation">,</span> <span class="token class-name">String</span> targetServer<span class="token punctuation">,</span> <span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DistroKey</span> distroKeyWithTarget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroKey</span><span class="token punctuation">(</span>distroKey<span class="token punctuation">.</span><span class="token function">getResourceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> distroKey<span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            targetServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DistroDelayTask</span> distroDelayTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroDelayTask</span><span class="token punctuation">(</span>distroKeyWithTarget<span class="token punctuation">,</span> action<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    distroTaskEngineHolder<span class="token punctuation">.</span><span class="token function">getDelayTaskExecuteEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>distroKeyWithTarget<span class="token punctuation">,</span> distroDelayTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO-SCHEDULE] {} to {}&quot;</span><span class="token punctuation">,</span> distroKey<span class="token punctuation">,</span> targetServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>进而会执行到DistroSyncChangeTask父类AbstractDistroExecuteTask中的run方法，选择当前支持的Distro的传输代理，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> type <span class="token operator">=</span> <span class="token function">getDistroKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//根据当前类型选择是HTTP还是GRPC的distro传输协议代理</span>
    <span class="token class-name">DistroTransportAgent</span> transportAgent <span class="token operator">=</span> distroComponentHolder<span class="token punctuation">.</span><span class="token function">findTransportAgent</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> transportAgent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No found transport agent for type [{}]&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO-START] {}&quot;</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transportAgent<span class="token punctuation">.</span><span class="token function">supportCallbackTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doExecuteWithCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DistroExecuteCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">executeDistroTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从而回调DistroSyncChangeTask类的doExecute方法，然后就会调用DistroClientTransportAgent类进行GRPC方式的数据同步，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">syncData</span><span class="token punctuation">(</span><span class="token class-name">DistroData</span> data<span class="token punctuation">,</span> <span class="token class-name">String</span> targetServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//检查目标服务器是否存储</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNoExistTarget</span><span class="token punctuation">(</span>targetServer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DistroDataRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroDataRequest</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//从集寻址配置中获得寻址信息</span>
    <span class="token class-name">Member</span> member <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>targetServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//检查当前服务的健康程度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkTargetServerStatusUnhealthy</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO] Cancel distro sync caused by target server {} unhealthy&quot;</span><span class="token punctuation">,</span> targetServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">//发送GRPC请求进行同步数据</span>
        <span class="token class-name">Response</span> response <span class="token operator">=</span> clusterRpcClientProxy<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>member<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">checkResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[DISTRO-FAILED] Sync distro data failed! &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-1-2、客户端订阅通知"><a href="#_2-1-2、客户端订阅通知" class="header-anchor">#</a> 2.1.2、客户端订阅通知</h4> <p>在V2版本的代码中，在服务端调用服务注册代码后，还额外会触发通知ServiceChangedEvent事件，这个事件的订阅者为：
NamingSubscriberServiceV2Impl，该类负责处理ServiceChangedEvent和ServiceSubscribedEvent，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">subscribeTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ServiceEvent<span class="token punctuation">.</span>ServiceChangedEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ServiceEvent<span class="token punctuation">.</span>ServiceSubscribedEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该事件主要会负责如下工作：</p> <p>1.通知订阅客户端</p> <p>2.Nacos集群数据同步。</p> <p>这样当Nacos服务端的某一台服务出现变更以后，会通过GRPC的方式向服务端发送请求，然后会发布<code>ServiceEvent.ServiceChangedEvent</code>事件，这个事件最后会在<code>NamingSubscriberServiceV2Impl.onEvent</code>中处理，会通过push方式（gRPC)将新上线的服务信息推送给消费方。</p> <h3 id="_2-2、其他非负责节点接收distro负责请求源码"><a href="#_2-2、其他非负责节点接收distro负责请求源码" class="header-anchor">#</a> 2.2、其他非负责节点接收Distro负责请求源码</h3> <h4 id="_2-2-1、grpc服务端启动流程"><a href="#_2-2-1、grpc服务端启动流程" class="header-anchor">#</a> 2.2.1、GRPC服务端启动流程</h4> <p>在Nacos服务器启动的时候，会开启GRPC的服务端端口，默认是在当前端口上偏移1000端口号，核心逻辑在BaseRpcServer类中，该类中的start方法上使用了Spring的@PostConstruct方法，进行项目启动的入口点，核心代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> serverName <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Nacos {} Rpc server starting at port {}&quot;</span><span class="token punctuation">,</span> serverName<span class="token punctuation">,</span> <span class="token function">getServicePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Nacos {} Rpc server started at port {}&quot;</span><span class="token punctuation">,</span> serverName<span class="token punctuation">,</span> <span class="token function">getServicePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Nacos {} Rpc server stopping&quot;</span><span class="token punctuation">,</span> serverName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">BaseRpcServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Nacos {} Rpc server stopped successfully...&quot;</span><span class="token punctuation">,</span> serverName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>REMOTE<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Nacos {} Rpc server stopped fail...&quot;</span><span class="token punctuation">,</span> serverName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-2-2、grpc服务端接收请求处理"><a href="#_2-2-2、grpc服务端接收请求处理" class="header-anchor">#</a> 2.2.2、GRPC服务端接收请求处理</h4> <p>当客户端已经连接负责节点的服务器后，然后发送了Distro的协议进行数据同步，该节点会向集群中的其他服务器发送Distro数据，作为集群中的Nacos节点的接收方的GRPC处理，会被GRPC的接收处理器所处理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">GrpcRequestAcceptor</span> grpcCommonRequestAcceptor<span class="token punctuation">;</span>
</code></pre></div><p>在GrpcRequestAcceptor类中负责接收各种GRPC的请求，从而根据当前请求拿到具体的请求实现处理类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RequestHandler</span> requestHandler <span class="token operator">=</span> requestHandlerRegistry<span class="token punctuation">.</span><span class="token function">getByRequestType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从而进入到DistroDataRequestHandler类中处理GRPC的DistroData数据同步请求，进而会执行到核心的接收数据处理中：</p> <div class="language-java extra-class"><pre class="language-java"><code>distroProtocol<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>distroData<span class="token punctuation">)</span>
</code></pre></div><p>在接下来的DistroClientDataProcessor类中，对于V2版本的GRPC的核心接收同步代码如下，进行当前服务节点的client模型的数据更新：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlerClientSyncData</span><span class="token punctuation">(</span><span class="token class-name">ClientSyncData</span> clientSyncData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[Client-Add] Received distro client sync data {}&quot;</span><span class="token punctuation">,</span> clientSyncData<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    clientManager<span class="token punctuation">.</span><span class="token function">syncClientConnected</span><span class="token punctuation">(</span>clientSyncData<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientSyncData<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Client</span> client <span class="token operator">=</span> clientManager<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span>clientSyncData<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">upgradeClient</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> clientSyncData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">upgradeClient</span><span class="token punctuation">(</span><span class="token class-name">Client</span> client<span class="token punctuation">,</span> <span class="token class-name">ClientSyncData</span> clientSyncData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> namespaces <span class="token operator">=</span> clientSyncData<span class="token punctuation">.</span><span class="token function">getNamespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> groupNames <span class="token operator">=</span> clientSyncData<span class="token punctuation">.</span><span class="token function">getGroupNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> serviceNames <span class="token operator">=</span> clientSyncData<span class="token punctuation">.</span><span class="token function">getServiceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstancePublishInfo</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> clientSyncData<span class="token punctuation">.</span><span class="token function">getInstancePublishInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">&gt;</span></span> syncedService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> namespaces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token class-name">Service</span><span class="token punctuation">.</span><span class="token function">newService</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> groupNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> serviceNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Service</span> singleton <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        syncedService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>singleton<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InstancePublishInfo</span> instancePublishInfo <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instancePublishInfo<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getInstancePublishInfo</span><span class="token punctuation">(</span>singleton<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            client<span class="token punctuation">.</span><span class="token function">addServiceInstance</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> instancePublishInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientRegisterServiceEvent</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Service</span> each <span class="token operator">:</span> client<span class="token punctuation">.</span><span class="token function">getAllPublishedService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>syncedService<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            client<span class="token punctuation">.</span><span class="token function">removeServiceInstance</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientDeregisterServiceEvent</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/18/2022, 10:03:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html" class="prev">
        第3节.服务端服务注册之基本处理流程
      </a></span> <span class="next"><a href="/nacos-guide/nacos2/第5节.Nacos中的DistroFilter服务注册路由/第5节.Nacos中的DistroFilter服务注册路由.html">
        第5节.Nacos中的DistroFilter服务注册路由
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nacos-guide/assets/js/app.58904bbc.js" defer></script><script src="/nacos-guide/assets/js/2.bcb8ada0.js" defer></script><script src="/nacos-guide/assets/js/36.1b19578b.js" defer></script>
  </body>
</html>

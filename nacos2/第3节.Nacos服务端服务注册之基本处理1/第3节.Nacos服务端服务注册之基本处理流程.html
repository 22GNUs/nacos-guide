<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第3节.Nacos服务端服务注册之基本处理流程 | Nacos Guide</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="分享微服务组件Nacos，学习其源码与思想">
    
    <link rel="preload" href="/nacos-guide/assets/css/0.styles.315a301c.css" as="style"><link rel="preload" href="/nacos-guide/assets/js/app.60b565f1.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/2.bcb8ada0.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/37.a6e1f603.js" as="script"><link rel="prefetch" href="/nacos-guide/assets/js/10.414297eb.js"><link rel="prefetch" href="/nacos-guide/assets/js/11.a90b0310.js"><link rel="prefetch" href="/nacos-guide/assets/js/12.cbf86bc9.js"><link rel="prefetch" href="/nacos-guide/assets/js/13.90b89aae.js"><link rel="prefetch" href="/nacos-guide/assets/js/14.738c7bbb.js"><link rel="prefetch" href="/nacos-guide/assets/js/15.d95b8c4a.js"><link rel="prefetch" href="/nacos-guide/assets/js/16.66e05b23.js"><link rel="prefetch" href="/nacos-guide/assets/js/17.4b4188c6.js"><link rel="prefetch" href="/nacos-guide/assets/js/18.548625a1.js"><link rel="prefetch" href="/nacos-guide/assets/js/19.3fb19de9.js"><link rel="prefetch" href="/nacos-guide/assets/js/20.b428aa50.js"><link rel="prefetch" href="/nacos-guide/assets/js/21.8a694ce3.js"><link rel="prefetch" href="/nacos-guide/assets/js/22.60431afb.js"><link rel="prefetch" href="/nacos-guide/assets/js/23.beabf292.js"><link rel="prefetch" href="/nacos-guide/assets/js/24.27303bad.js"><link rel="prefetch" href="/nacos-guide/assets/js/25.563997aa.js"><link rel="prefetch" href="/nacos-guide/assets/js/26.ec63f162.js"><link rel="prefetch" href="/nacos-guide/assets/js/27.54431b01.js"><link rel="prefetch" href="/nacos-guide/assets/js/28.ceb139ec.js"><link rel="prefetch" href="/nacos-guide/assets/js/29.b88b01c0.js"><link rel="prefetch" href="/nacos-guide/assets/js/3.c4a4c22c.js"><link rel="prefetch" href="/nacos-guide/assets/js/30.b7181648.js"><link rel="prefetch" href="/nacos-guide/assets/js/31.30443e1f.js"><link rel="prefetch" href="/nacos-guide/assets/js/32.82114ebd.js"><link rel="prefetch" href="/nacos-guide/assets/js/33.19fff8f7.js"><link rel="prefetch" href="/nacos-guide/assets/js/34.4bd4fa81.js"><link rel="prefetch" href="/nacos-guide/assets/js/35.2d7b3a68.js"><link rel="prefetch" href="/nacos-guide/assets/js/36.cc5e6ecc.js"><link rel="prefetch" href="/nacos-guide/assets/js/38.79ff3cc1.js"><link rel="prefetch" href="/nacos-guide/assets/js/39.64e41f37.js"><link rel="prefetch" href="/nacos-guide/assets/js/4.f6e10ae8.js"><link rel="prefetch" href="/nacos-guide/assets/js/40.a940545b.js"><link rel="prefetch" href="/nacos-guide/assets/js/41.6c20bb56.js"><link rel="prefetch" href="/nacos-guide/assets/js/42.b1edc063.js"><link rel="prefetch" href="/nacos-guide/assets/js/43.de2be6af.js"><link rel="prefetch" href="/nacos-guide/assets/js/44.02e3dd7b.js"><link rel="prefetch" href="/nacos-guide/assets/js/45.23034a35.js"><link rel="prefetch" href="/nacos-guide/assets/js/46.b575e120.js"><link rel="prefetch" href="/nacos-guide/assets/js/47.abaf58c3.js"><link rel="prefetch" href="/nacos-guide/assets/js/48.b00979df.js"><link rel="prefetch" href="/nacos-guide/assets/js/49.0fe2d605.js"><link rel="prefetch" href="/nacos-guide/assets/js/5.4fed097f.js"><link rel="prefetch" href="/nacos-guide/assets/js/50.c72a411d.js"><link rel="prefetch" href="/nacos-guide/assets/js/51.9d1222ac.js"><link rel="prefetch" href="/nacos-guide/assets/js/52.ea1fc83f.js"><link rel="prefetch" href="/nacos-guide/assets/js/6.7e831ffb.js"><link rel="prefetch" href="/nacos-guide/assets/js/7.ee4b8294.js"><link rel="prefetch" href="/nacos-guide/assets/js/8.7b939dff.js"><link rel="prefetch" href="/nacos-guide/assets/js/9.b0e9368c.js">
    <link rel="stylesheet" href="/nacos-guide/assets/css/0.styles.315a301c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nacos-guide/" class="home-link router-link-active"><!----> <span class="site-name">Nacos Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/pattern/" class="nav-link">
  Nacos设计模式
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link router-link-active">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/pattern/" class="nav-link">
  Nacos设计模式
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基于Nacos2.1.0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nacos-guide/nacos2/第1节.Nacos源码开篇及环境搭建/第1节.Nacos源码开篇及环境搭建.html" class="sidebar-link">第1节.Nacos源码开篇及环境搭建</a></li><li><a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html" class="sidebar-link">第2节.Nacos客户端服务注册源码分析</a></li><li><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html" class="active sidebar-link">第3节.服务端服务注册之基本处理流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#一、http方式的服务注册" class="sidebar-link">一、HTTP方式的服务注册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#_1-1、服务注册控制器controller" class="sidebar-link">1.1、服务注册控制器Controller</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#_1-2、服务信息service创建" class="sidebar-link">1.2、服务信息Service创建</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#_1-3、服务实例信息instance创建" class="sidebar-link">1.3、服务实例信息Instance创建</a></li></ul></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#二、grpc方式的服务注册" class="sidebar-link">二、GRPC方式的服务注册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#_2-1、服务注册控制器controller" class="sidebar-link">2.1、服务注册控制器Controller</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#_2-2、服务信息service与instance创建" class="sidebar-link">2.2、服务信息Service与Instance创建</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/nacos2/第3节.Nacos服务端服务注册之基本处理1/第3节.Nacos服务端服务注册之基本处理流程.html#_2-3、服务信息映射事件处理" class="sidebar-link">2.3、服务信息映射事件处理</a></li></ul></li></ul></li><li><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html" class="sidebar-link">第4节.服务端服务注册之Distro协议注册与异步复制</a></li><li><a href="/nacos-guide/nacos2/第5节.Nacos中的DistroFilter服务注册路由/第5节.Nacos中的DistroFilter服务注册路由.html" class="sidebar-link">第5节.Nacos中的DistroFilter服务注册路由</a></li><li><a href="/nacos-guide/nacos2/第6节.Nacos服务端服务健康检查源码分析/第6节.Nacos服务端服务健康检查源码分析.html" class="sidebar-link">第6节.Nacos服务端服务健康检查源码分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第3节-nacos服务端服务注册之基本处理流程"><a href="#第3节-nacos服务端服务注册之基本处理流程" class="header-anchor">#</a> 第3节.Nacos服务端服务注册之基本处理流程</h1> <p>在Nacos中2.x以前默认情况下客户端采用HTTP的方式进行服务与实例的注册，从2.x开始，对于临时实例则采用支GRPC的方式进行服务注册，持久化实例依然用HTTP方式注册。</p> <h2 id="一、http方式的服务注册"><a href="#一、http方式的服务注册" class="header-anchor">#</a> 一、HTTP方式的服务注册</h2> <p>通过阅读官方文档可以知道，对于HTTP注册来说，服务端处理的API地址为：</p> <p>http://ip:port/nacos/v1/ns/instance/register</p> <h3 id="_1-1、服务注册控制器controller"><a href="#_1-1、服务注册控制器controller" class="header-anchor">#</a> 1.1、服务注册控制器Controller</h3> <p>查看naming模块的InstanceController类的接口实现的代码如下所示</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@CanDistro</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>action <span class="token operator">=</span> <span class="token class-name">ActionTypes</span><span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得当前请求中的命名空间信息，如果不存在则使用默认的命名空间</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> <span class="token class-name">WebUtils</span>
                <span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span>NAMESPACE_ID<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_NAMESPACE_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得当前请求中的服务名称，如果不存在则使用默认的服务名称</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">CommonParams</span><span class="token punctuation">.</span>SERVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查服务名称是否合法</span>
        <span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">checkServiceNameFormat</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将当前信息构造为一个Instance实例对象</span>
        <span class="token keyword">final</span> <span class="token class-name">Instance</span> instance <span class="token operator">=</span> <span class="token class-name">HttpRequestInstanceBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDefaultInstanceEphemeral</span><span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">isDefaultInstanceEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据当前对GRPC的支持情况 调用符合条件的处理，支持GRPC特征则调用InstanceOperatorClientImpl</span>
        <span class="token function">getInstanceOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>对于最后一行的getInstanceOperator()方法，就是根据当前对GRPC的支持选择：</p> <ul><li>如果当前支持GRPC，则调用V2版本的InstanceOperatorClientImpl类的registerInstance方法</li> <li>如果当前不支持GRPC特征，则调用V1版本的InstanceOperatorServiceImpl类的registerInstance方法</li></ul> <p>这里我们看V1版本的逻辑，service层的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建服务信息，不存在则进行创建，同时创建service、cluster的关系</span>
  			<span class="token comment">//同时初始化service的时候，创建服务端的心跳检测判断任务</span>
        <span class="token function">createEmptyService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 再次获得服务信息</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 再次判断服务</span>
        <span class="token function">checkServiceIsNull</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加实例信息</span>
        <span class="token function">addInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法中，核心的逻辑在服务创建的createEmptyService方法、实例创建的addInstance方法</p> <h3 id="_1-2、服务信息service创建"><a href="#_1-2、服务信息service创建" class="header-anchor">#</a> 1.2、服务信息Service创建</h3> <p>调用关系处理如下：</p> <div class="language- extra-class"><pre class="language-text"><code>createEmptyService
		createServiceIfAbsent
				putServiceAndInit
        addOrReplaceService
</code></pre></div><p>其中createEmptyService方法中createServiceIfAbsent的核心逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createServiceIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> local<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
        <span class="token comment">//从缓存中获取服务信息</span>
        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>SRV_LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;creating empty service {}:{}&quot;</span><span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//初始化service</span>
            service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">setNamespaceId</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span><span class="token class-name">NamingUtils</span><span class="token punctuation">.</span><span class="token function">getGroupName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// now validate the service. if failed, exception will be thrown</span>
            service<span class="token punctuation">.</span><span class="token function">setLastModifiedMillis</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//关联服务和集群的关系</span>
                cluster<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//校验服务名称等是否合规</span>
            service<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//初始话服务信息，创建心跳检测任务</span>
            <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//是否是临时服务，一致性处理</span>
                <span class="token function">addOrReplaceService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>在putServiceAndInit方法中的核心逻辑就是将当前服务信息放置到缓存中，同时调用初始化方法开启服务端的心跳检测任务，用于判断当前服务下的实例信息的变化，如果有变化则同时客户端.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 开启当前服务的心跳检测任务</span>
    <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>clientBeatCheckTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Cluster</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> clusterMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于clientBeatCheckTask任务的具体实现后续在进行说明。</p> <h3 id="_1-3、服务实例信息instance创建"><a href="#_1-3、服务实例信息instance创建" class="header-anchor">#</a> 1.3、服务实例信息Instance创建</h3> <p>调用关系处理如下：</p> <div class="language- extra-class"><pre class="language-text"><code>addInstance
		addIpAddresses
		consistencyService.put(key, instances)
</code></pre></div><p>addInstance方法核心逻辑说明如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ips<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token comment">//构建key</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> ephemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从缓存中获得服务信息</span>
    <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//为服务设置一把锁</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这个方法里面就是最核心的对命名空间-&gt;服务-&gt;cluster-&gt;instance</span>
        <span class="token comment">//基于这套数据结构和模型完成内存服务注册,就是在这里</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> instanceList <span class="token operator">=</span> <span class="token function">addIpAddresses</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> ephemeral<span class="token punctuation">,</span> ips<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Instances</span> instances <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instances<span class="token punctuation">.</span><span class="token function">setInstanceList</span><span class="token punctuation">(</span>instanceList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 真正你的Distro协议生效，主要是在这里，会去走distro的put逻辑</span>
        <span class="token comment">// 会把你的服务实例数据页放在内存里,同时发起一个延迟异步任务的sync的数据复制任务</span>
        <span class="token comment">// 延迟一段时间</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于addIpAddresses方法来说，核心的就是创建起相关的关联关系</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> <span class="token function">updateIpAddresses</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">String</span> action<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ephemeral<span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ips<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    
    <span class="token class-name">Datum</span> datum <span class="token operator">=</span> consistencyService
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ephemeral<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> currentIPs <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span>ephemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> currentInstances <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>currentIPs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentInstanceIds <span class="token operator">=</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> instance <span class="token operator">:</span> currentIPs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentInstances<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">toIpAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentInstanceIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> instanceMap<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>datum <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">!=</span> datum<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instanceMap <span class="token operator">=</span> <span class="token function">setValid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Instances</span><span class="token punctuation">)</span> datum<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstanceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        instanceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ips<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Instance</span> instance <span class="token operator">:</span> ips<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cluster</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cluster<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>SRV_LOG
                    <span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;cluster: {} not found, ip: {}, will create new cluster with default configuration.&quot;</span><span class="token punctuation">,</span>
                            instance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>UPDATE_INSTANCE_ACTION_REMOVE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instanceMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getDatumKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Instance</span> oldInstance <span class="token operator">=</span> instanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getDatumKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldInstance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance<span class="token punctuation">.</span><span class="token function">setInstanceId</span><span class="token punctuation">(</span>oldInstance<span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                instance<span class="token punctuation">.</span><span class="token function">setInstanceId</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">generateInstanceId</span><span class="token punctuation">(</span>currentInstanceIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            instanceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getDatumKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>UPDATE_INSTANCE_ACTION_ADD<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;ip list can not be empty, service: &quot;</span> <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, ip list: &quot;</span> <span class="token operator">+</span> <span class="token class-name">JacksonUtils</span>
                        <span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>instanceMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>instanceMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该方法结束以后，命名空间-&gt;服务-&gt;cluster-&gt;instance，这个存储结构的关系就确定了。</p> <h2 id="二、grpc方式的服务注册"><a href="#二、grpc方式的服务注册" class="header-anchor">#</a> 二、GRPC方式的服务注册</h2> <p>对于V2版本的服务端的服务注册的实现类，会由InstanceOperatorClientImpl类进行处理。</p> <h3 id="_2-1、服务注册控制器controller"><a href="#_2-1、服务注册控制器controller" class="header-anchor">#</a> 2.1、服务注册控制器Controller</h3> <p>当前V2版本为了兼容处理，同时提供了HTTP接口进行服务注册与GRPC方式注册：</p> <ul><li><p>对于客户端采用HTTP接口方式的调用，服务端的InstanceController类进行处理流转，同时客户端根据条件动态选择客户端操作类。InstanceController-----&gt;InstanceOperatorClientImpl-----&gt;ClientOperationServiceProxy-----&gt;registerInstance方法</p></li> <li><p>对于客户端采用GRPC接口方式的调用，服务端gRPC实现是继承BaseGrpcServer，其子类主要是不同线程池的选择，其中GrpcSdkServer用来处理和客户端之间的通信，GrpcClusterServer用来集群节点之间的通信。而相关请求在GrpcRequestAcceptor根据不同请求类型获取RequestHandlerRegistry对应的RequestHandler进行处理。服务端的InstanceRequestHandler类进行处理流程，同时客户端操作类为临时实例处理。</p> <p>InstanceRequestHandler-----&gt;EphemeralClientOperationServiceImpl-----&gt;registerInstance方法</p></li></ul> <p>最终会调用到在ClientOperationServiceProxy的registerInstance方法或其子类的EphemeralClientOperationServiceImpl的registerInstance方法</p> <p>InstanceOperatorClientImpl类的registerInstance注册方法如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> namespaceId<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> ephemeral <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//构造一个clientId</span>
    <span class="token class-name">String</span> clientId <span class="token operator">=</span> <span class="token class-name">IpPortBasedClient</span><span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">toInetAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ephemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将ClientId进行缓存存储，存储到clientmanage中</span>
    <span class="token function">createIpPortClientIfAbsent</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新的方式构造一个服务信息</span>
    <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> ephemeral<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clientOperationService是一个临时实例还是持久化实例的代理类，去管理不同实例的注册行为</span>
    clientOperationService<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nacos2.x以后新增Client模型**。**一个客户端gRPC长连接对应一个Client，每个Client有自己唯一的id（clientId）。Client负责管理一个客户端的服务实例注册Publish和服务订阅Subscribe。我们可以看一下这个模型其实就是一个接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token comment">// 客户端id/gRPC的connectionId</span>
    <span class="token class-name">String</span> <span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 是否临时客户端</span>
    <span class="token keyword">boolean</span> <span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 客户端更新时间</span>
    <span class="token keyword">void</span> <span class="token function">setLastUpdatedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">getLastUpdatedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 服务实例注册/注销/查询</span>
    <span class="token keyword">boolean</span> <span class="token function">addServiceInstance</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">InstancePublishInfo</span> instancePublishInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InstancePublishInfo</span> <span class="token function">removeServiceInstance</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InstancePublishInfo</span> <span class="token function">getInstancePublishInfo</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllPublishedService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 服务订阅/取消订阅/查询订阅</span>
    <span class="token keyword">boolean</span> <span class="token function">addServiceSubscriber</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">Subscriber</span> subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">removeServiceSubscriber</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Subscriber</span> <span class="token function">getSubscriber</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllSubscribeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成同步给其他节点的client数据</span>
    <span class="token class-name">ClientSyncData</span> <span class="token function">generateSyncData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否过期</span>
    <span class="token keyword">boolean</span> <span class="token function">isExpire</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 释放资源</span>
    <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-2、服务信息service与instance创建"><a href="#_2-2、服务信息service与instance创建" class="header-anchor">#</a> 2.2、服务信息Service与Instance创建</h3> <p>临时实例的EphemeralClientOperationServiceImpl的registerInstance方法核心逻辑如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">Instance</span> instance<span class="token punctuation">,</span> <span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建及存储获得服务和命名空间的关系</span>
    <span class="token class-name">Service</span> singleton <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>singleton<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosRuntimeException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>INVALID_PARAM<span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Current service %s is persistent service, can't register ephemeral instance.&quot;</span><span class="token punctuation">,</span>
                        singleton<span class="token punctuation">.</span><span class="token function">getGroupedServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// V2版本使用client模型处理客户端信息,知道具体的客户端</span>
    <span class="token class-name">Client</span> client <span class="token operator">=</span> clientManager<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">clientIsLegal</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 定义一个新的实例信息，并派发事件</span>
    <span class="token class-name">InstancePublishInfo</span> instanceInfo <span class="token operator">=</span> <span class="token function">getPublishInfo</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">addServiceInstance</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> instanceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">setLastUpdatedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientRegisterServiceEvent</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NotifyCenter</span>
            <span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MetadataEvent<span class="token punctuation">.</span>InstanceMetadataEvent</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span> instanceInfo<span class="token punctuation">.</span><span class="token function">getMetadataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法里面涉及到的V2版本中的很多新加入的设计，ServiceManager、ClientManager</p> <p>Service的容器是ServiceManager，但是在com.alibaba.nacos.naming.core.v2包下，容器中Service都是单例。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceManager</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ServiceManager</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//单例Service，可以查看Service的equals和hasCode方法</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">,</span> <span class="token class-name">Service</span><span class="token punctuation">&gt;</span></span> singletonRepository<span class="token punctuation">;</span>
    <span class="token comment">//namespace下的所有service</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> namespaceSingletonMaps<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以从这个位置可以看出，当调用这个注册方法的时候<strong>ServiceManager</strong>负责管理Service单例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//通过Map储存单例的Service</span>
<span class="token keyword">public</span> <span class="token class-name">Service</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    singletonRepository<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Service</span> result <span class="token operator">=</span> singletonRepository<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    namespaceSingletonMaps<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>namespace<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    namespaceSingletonMaps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这是一个接口这里我们要看它对应的一个实现类<strong>ConnectionBasedClientManager</strong>，这个实现类负责管理长连接clientId与Client模型的映射关系</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 根据clientId查询Client</span>
<span class="token keyword">public</span> <span class="token class-name">Client</span> <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Client实例AbstractClient负责存储当前客户端的服务注册表，即Service与Instance的关系。注意<strong>对于单个客户端来说，同一个服务只能注册一个实例</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addServiceInstance</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">InstancePublishInfo</span> instancePublishInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> publishers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> instancePublishInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">incrementInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientChangedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>SRV_LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Client change for service {}, {}&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-3、服务信息映射事件处理"><a href="#_2-3、服务信息映射事件处理" class="header-anchor">#</a> 2.3、服务信息映射事件处理</h3> <p>在上面的流程中，可以看到调用通知中心派发了2个事件：</p> <p>new ClientOperationEvent.ClientRegisterServiceEvent(singleton, clientId)</p> <p>new MetadataEvent.InstanceMetadataEvent(singleton, instanceInfo.getMetadataId()</p> <p>这里的目的是为了过滤目标服务得到最终Instance列表建立Service与Client的关系，建立Service与Client的关系就是为了加速查询。</p> <p>ClientServiceIndexesManager类服务处理这个类的监听业务，ClientServiceIndexesManager维护了两个索引：</p> <ul><li>Service与发布clientId</li> <li>Service与订阅clientId</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> publisherIndexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> subscriberIndexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleClientOperation</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Service</span> service <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> clientId <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientRegisterServiceEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addPublisherIndexes</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientDeregisterServiceEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removePublisherIndexes</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientSubscribeServiceEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addSubscriberIndexes</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientUnsubscribeServiceEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeSubscriberIndexes</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//建立Service与发布Client的关系</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addPublisherIndexes</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    publisherIndexes<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    publisherIndexes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceEvent<span class="token punctuation">.</span>ServiceChangedEvent</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从ClientServiceIndexesManager类的源代码中可以看到，该类注册订阅了4个事件：</p> <p>客户端注册服务事件、客户端取消注册服务事件、客户端订阅服务事件、客户端取消订阅服务事件</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">subscribeTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Event</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientRegisterServiceEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientDeregisterServiceEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientSubscribeServiceEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientUnsubscribeServiceEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientDisconnectEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个索引关系建立以后，还会触发<strong>ServiceChangedEvent</strong>，代表服务注册表变更。对于注册表变更紧接着还要做两个事情：</p> <p>1.通知订阅客户端</p> <p>2.Nacos集群数据同步。</p> <p>这两点后续再说。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/18/2022, 10:03:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nacos-guide/nacos2/第2节.Nacos客户端服务注册源码分析/第2节.Nacos客户端服务注册源码分析.html" class="prev">
        第2节.Nacos客户端服务注册源码分析
      </a></span> <span class="next"><a href="/nacos-guide/nacos2/第4节.Nacos服务端服务注册之基本处理2/第4节.Nacos服务端服务注册之Distro协议注册与异步复制.html">
        第4节.服务端服务注册之Distro协议注册与异步复制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nacos-guide/assets/js/app.60b565f1.js" defer></script><script src="/nacos-guide/assets/js/2.bcb8ada0.js" defer></script><script src="/nacos-guide/assets/js/37.a6e1f603.js" defer></script>
  </body>
</html>

# 第9节.Nacos中的健康检查说明

## 一、基本介绍

nacos默认提供了TCP、MySQL、HTTP三种方式去检查当前相关数据是否处于健康的状态。

在nacos-naming模块中的com.alibaba.nacos.naming.healthcheck包下，定义了相关的健康检查的处理实现。

HealthCheckExtendProvider类负责加载健康检查的检查器类型、处理器实现接口。通过改扩展我们可以自定义自己的实现。

Nacos中提供两种健康检查机制：

1. 客户端主动上报机制
2. 服务器端主动下探机制

如何理解这两种机制呢？可以想象一个场景，你在学校的教室里面，遇到学业上的问题，或者是科目上的问题。那有什么办法让老师知道你有问题？

- 第一种，你主动去找老师并且告诉老师你的问题和精神状态（健康状态）
- 第二种，老师自己发现你的状态有问题，及主动询问你的问题和状态

## 二、主要介绍

**Nacos中的健康检查机制不能主动设置，但健康检查机制是和Nacos的服务实例类型强相关的**。也就是说Nacos中的两种服务实例分别对应了两种健康检查机制：

1. 临时实例（非持久化实例）：对应客户端主动上报机制
2. 永久实例（持久化实例）：对应服务器端主动下探机制

为什么需要两种服务实例呢？
 以淘宝为例，双十一大促期间，流量会比平时高出很多，此时服务肯定需要增加更多实例来应对高并发，而这些实例在双十一之后就无需继续使用了，采用临时实例比较合适。而对于服务的一些常备实例，则使用永久实例更为合适。

### 2.1、客户端主动上报机制（1.x时代）

临时实例每隔5秒会主动上报一次自己的健康状态，发送的数据包叫做`心跳包`,发送心跳包的机制叫做`心跳机制`。如果心跳包的间隔时间超过了15秒，那么Nacos服务器端就会将此服务实例标记为非健康实例，如果心跳包超过30 秒，那么Nacos服务器端将会把此服务实例从服务列表中剔除。

### 2.2、服务器端主动下探机制

永久实例使用的服务器端主动下探机制的方式实现健康检查的，它的探测周期是2000毫秒+随件数（5000毫秒内），如果检测异常会将此服务实例，标记为非健康实例，但不会把服务实例像临时实例那样中服务列表中剔除。**Nacos服务器向下探方式目前内置了3种探测协议：HTTP探测、TCP探测和Mysql探测**。一般而言HTTP和TCP探测已经可以涵盖绝大多数的健康检查场景，Mysql主要用于特殊的业务场景，列如数据库的主备需要通过服务外对外提供访问，需要确定当前访问数据库是否为主库时，那么我们此时的健康检查接口，是一个检查数据库是否为主库的Mysql命令。

默认情况下，永久实例使用的是TCP探测，这点可以在Nacos控制台观察到,如图:


<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第5节.Nacos中委派设计模式的使用 | Nacos Guide</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="分享微服务组件Nacos，学习其源码与思想">
    
    <link rel="preload" href="/nacos-guide/assets/css/0.styles.315a301c.css" as="style"><link rel="preload" href="/nacos-guide/assets/js/app.60b565f1.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/2.bcb8ada0.js" as="script"><link rel="preload" href="/nacos-guide/assets/js/45.23034a35.js" as="script"><link rel="prefetch" href="/nacos-guide/assets/js/10.414297eb.js"><link rel="prefetch" href="/nacos-guide/assets/js/11.a90b0310.js"><link rel="prefetch" href="/nacos-guide/assets/js/12.cbf86bc9.js"><link rel="prefetch" href="/nacos-guide/assets/js/13.90b89aae.js"><link rel="prefetch" href="/nacos-guide/assets/js/14.738c7bbb.js"><link rel="prefetch" href="/nacos-guide/assets/js/15.d95b8c4a.js"><link rel="prefetch" href="/nacos-guide/assets/js/16.66e05b23.js"><link rel="prefetch" href="/nacos-guide/assets/js/17.4b4188c6.js"><link rel="prefetch" href="/nacos-guide/assets/js/18.548625a1.js"><link rel="prefetch" href="/nacos-guide/assets/js/19.3fb19de9.js"><link rel="prefetch" href="/nacos-guide/assets/js/20.b428aa50.js"><link rel="prefetch" href="/nacos-guide/assets/js/21.8a694ce3.js"><link rel="prefetch" href="/nacos-guide/assets/js/22.60431afb.js"><link rel="prefetch" href="/nacos-guide/assets/js/23.beabf292.js"><link rel="prefetch" href="/nacos-guide/assets/js/24.27303bad.js"><link rel="prefetch" href="/nacos-guide/assets/js/25.563997aa.js"><link rel="prefetch" href="/nacos-guide/assets/js/26.ec63f162.js"><link rel="prefetch" href="/nacos-guide/assets/js/27.54431b01.js"><link rel="prefetch" href="/nacos-guide/assets/js/28.ceb139ec.js"><link rel="prefetch" href="/nacos-guide/assets/js/29.b88b01c0.js"><link rel="prefetch" href="/nacos-guide/assets/js/3.c4a4c22c.js"><link rel="prefetch" href="/nacos-guide/assets/js/30.b7181648.js"><link rel="prefetch" href="/nacos-guide/assets/js/31.30443e1f.js"><link rel="prefetch" href="/nacos-guide/assets/js/32.82114ebd.js"><link rel="prefetch" href="/nacos-guide/assets/js/33.19fff8f7.js"><link rel="prefetch" href="/nacos-guide/assets/js/34.4bd4fa81.js"><link rel="prefetch" href="/nacos-guide/assets/js/35.2d7b3a68.js"><link rel="prefetch" href="/nacos-guide/assets/js/36.cc5e6ecc.js"><link rel="prefetch" href="/nacos-guide/assets/js/37.a6e1f603.js"><link rel="prefetch" href="/nacos-guide/assets/js/38.79ff3cc1.js"><link rel="prefetch" href="/nacos-guide/assets/js/39.64e41f37.js"><link rel="prefetch" href="/nacos-guide/assets/js/4.f6e10ae8.js"><link rel="prefetch" href="/nacos-guide/assets/js/40.a940545b.js"><link rel="prefetch" href="/nacos-guide/assets/js/41.6c20bb56.js"><link rel="prefetch" href="/nacos-guide/assets/js/42.b1edc063.js"><link rel="prefetch" href="/nacos-guide/assets/js/43.de2be6af.js"><link rel="prefetch" href="/nacos-guide/assets/js/44.02e3dd7b.js"><link rel="prefetch" href="/nacos-guide/assets/js/46.b575e120.js"><link rel="prefetch" href="/nacos-guide/assets/js/47.abaf58c3.js"><link rel="prefetch" href="/nacos-guide/assets/js/48.b00979df.js"><link rel="prefetch" href="/nacos-guide/assets/js/49.0fe2d605.js"><link rel="prefetch" href="/nacos-guide/assets/js/5.4fed097f.js"><link rel="prefetch" href="/nacos-guide/assets/js/50.c72a411d.js"><link rel="prefetch" href="/nacos-guide/assets/js/51.9d1222ac.js"><link rel="prefetch" href="/nacos-guide/assets/js/52.ea1fc83f.js"><link rel="prefetch" href="/nacos-guide/assets/js/6.7e831ffb.js"><link rel="prefetch" href="/nacos-guide/assets/js/7.ee4b8294.js"><link rel="prefetch" href="/nacos-guide/assets/js/8.7b939dff.js"><link rel="prefetch" href="/nacos-guide/assets/js/9.b0e9368c.js">
    <link rel="stylesheet" href="/nacos-guide/assets/css/0.styles.315a301c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nacos-guide/" class="home-link router-link-active"><!----> <span class="site-name">Nacos Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/pattern/" class="nav-link router-link-active">
  Nacos设计模式
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nacos-guide/guide/list/01.html" class="nav-link">
  导读
</a></div><div class="nav-item"><a href="/nacos-guide/basic/" class="nav-link">
  基本使用
</a></div><div class="nav-item"><a href="/nacos-guide/nacos2/" class="nav-link">
  Nacos2源码分析
</a></div><div class="nav-item"><a href="/nacos-guide/design/" class="nav-link">
  Nacos代码设计
</a></div><div class="nav-item"><a href="/nacos-guide/pattern/" class="nav-link router-link-active">
  Nacos设计模式
</a></div><div class="nav-item"><a href="/nacos-guide/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/nacos-guide/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/wuchubuzai2018/nacos-guide" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nacos设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html" class="active sidebar-link">第1节.Nacos中的委派设计模式的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html#一、委派设计模式概念" class="sidebar-link">一、委派设计模式概念</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html#二、委派设计模式角色" class="sidebar-link">二、委派设计模式角色</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html#三、nacos中委派模式的使用" class="sidebar-link">三、Nacos中委派模式的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html#_1、客户端模块的请求委派处理" class="sidebar-link">1、客户端模块的请求委派处理</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html#_2、服务端模块的客户端管理器委派处理" class="sidebar-link">2、服务端模块的客户端管理器委派处理</a></li><li class="sidebar-sub-header"><a href="/nacos-guide/pattern/第1节.Nacos中的委派设计模式的使用.html#_3、服务端模块的一致性协议委派处理" class="sidebar-link">3、服务端模块的一致性协议委派处理</a></li></ul></li></ul></li><li><a href="/nacos-guide/pattern/第2节.Nacos中的模板方法设计模式的使用.html" class="sidebar-link">第2节.Nacos中的模板方法设计模式的使用</a></li><li><a href="/nacos-guide/pattern/第3节.Nacos中的装饰者设计模式的使用.html" class="sidebar-link">第3节.Nacos中的装饰者设计模式的使用</a></li><li><a href="/nacos-guide/pattern/第4节.Nacos中的策略设计模式的使用.html" class="sidebar-link">第4节.Nacos中的策略设计模式的使用</a></li><li><a href="/nacos-guide/pattern/第5节.Nacos中的建造者设计模式的使用.html" class="sidebar-link">第5节.Nacos中建造者设计模式的使用</a></li><li><a href="/nacos-guide/pattern/第6节.Nacos中的观察者设计模式的使用.html" class="sidebar-link">第6节.Nacos中的观察者设计模式的使用</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第5节-nacos中委派设计模式的使用"><a href="#第5节-nacos中委派设计模式的使用" class="header-anchor">#</a> 第5节.Nacos中委派设计模式的使用</h1> <h2 id="一、委派设计模式概念"><a href="#一、委派设计模式概念" class="header-anchor">#</a> 一、委派设计模式概念</h2> <p>委派就像是拿另一种方法替代了原本的方法，交给现在这个替代后的方法使用，使用时和原来的方法没有区别。</p> <p>允许对象组合实现与继承相同的代码重用。它的基本作用就是负责任务的调用和分配任务，是一种特殊的静态代理，可以理解我全权代理，但是代码模式注重过程，而委派模式注重结果。属于行为型模式。</p> <h2 id="二、委派设计模式角色"><a href="#二、委派设计模式角色" class="header-anchor">#</a> 二、委派设计模式角色</h2> <ol><li>抽象任务角色（Task）：定义一个接口，它有若干实现类。</li> <li>委派角色（Delegate）：负责在各个具体角色实例之间做出决策，屏判断调用具体实现的方法。</li> <li>具体任务角色（Concrete）真正执行任务的角色</li></ol> <p>通常我们看到某个类的名称中包含Delegete字符串，基本上都是一种委派设计模式的体现。类关系如下:</p> <p>client</p> <p>调用</p> <p>Delegate类----------实现-----------任务角色接口</p> <p>具体任务角色1----------实现-----------任务角色接口</p> <p>具体任务角色2----------实现-----------任务角色接口</p> <h2 id="三、nacos中委派模式的使用"><a href="#三、nacos中委派模式的使用" class="header-anchor">#</a> 三、Nacos中委派模式的使用</h2> <h3 id="_1、客户端模块的请求委派处理"><a href="#_1、客户端模块的请求委派处理" class="header-anchor">#</a> 1、客户端模块的请求委派处理</h3> <p>以客户端的请求入口NacosNamingService类为起点，在该类的构造函数中对接口NamingClientProxy进行了委派的初始化，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>clientProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingClientProxyDelegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namespace<span class="token punctuation">,</span> serviceInfoHolder<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> changeNotifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>所以角色对应关系如下：</p> <table><thead><tr><th>角色名称</th> <th>对应接口/类</th></tr></thead> <tbody><tr><td>抽象任务角色</td> <td>NamingClientProxy</td></tr> <tr><td>委派角色</td> <td>NamingClientProxyDelegate</td></tr> <tr><td>具体任务角色</td> <td>NamingHttpClientProxy、NamingGrpcClientProxy</td></tr></tbody></table> <p>可以了解到NacosNamingService中的客户端请求的业务逻辑设计为委派模式，去根据自己的业务去控制什么时候采用HTTP请求，什么时候采用GRPC请求。</p> <p>在Nacos2.1版本中：</p> <p>对于客户端注册服务方法registerService和取消注册服务方法deregisterService的逻辑，采用动态判断，当实例为临时的方式的时候，使用grpcClientProxy，非临时采用httpClientProxy。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">NamingClientProxy</span> <span class="token function">getExecuteClientProxy</span><span class="token punctuation">(</span><span class="token class-name">Instance</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> grpcClientProxy <span class="token operator">:</span> httpClientProxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于获得服务列表的方法，采用的grpcClientProxy的方式：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ListView</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServiceList</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNo<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">AbstractSelector</span> selector<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> grpcClientProxy<span class="token punctuation">.</span><span class="token function">getServiceList</span><span class="token punctuation">(</span>pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于订阅subscribe和取消订阅的方法，采用的也是grpcClientProxy的方式。</p> <h3 id="_2、服务端模块的客户端管理器委派处理"><a href="#_2、服务端模块的客户端管理器委派处理" class="header-anchor">#</a> 2、服务端模块的客户端管理器委派处理</h3> <p>以服务端的接收心跳HealthController类为起点，在该类的会判断当前服务器是否支持GRPC的特征，如果是则使用Nacos2中的HealthOperatorV2Impl类进行心跳操作的相关处理，而这个类中需要注入一个ClientManager客户管理期委托实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">HealthOperatorV2Impl</span><span class="token punctuation">(</span><span class="token class-name">NamingMetadataManager</span> metadataManager<span class="token punctuation">,</span> <span class="token class-name">ClientManagerDelegate</span> clientManager<span class="token punctuation">,</span>
        <span class="token class-name">ClientOperationServiceProxy</span> clientOperationService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>metadataManager <span class="token operator">=</span> metadataManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clientManager <span class="token operator">=</span> clientManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clientOperationService <span class="token operator">=</span> clientOperationService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以角色对应关系如下：</p> <table><thead><tr><th>角色名称</th> <th>对应接口/类</th></tr></thead> <tbody><tr><td>抽象任务角色</td> <td>ClientManager</td></tr> <tr><td>委派角色</td> <td>ClientManagerDelegate</td></tr> <tr><td>具体任务角色</td> <td>ConnectionBasedClientManager、EphemeralIpPortClientManager、PersistentIpPortClientManager</td></tr></tbody></table> <p>通过判断客户端的ID信息，委派不同的任务角色进行处理，核心判断逻辑如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ClientManager</span> <span class="token function">getClientManagerById</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isConnectionBasedClient</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> connectionBasedClientManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> clientId<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token class-name">ClientConstants</span><span class="token punctuation">.</span>PERSISTENT_SUFFIX<span class="token punctuation">)</span> <span class="token operator">?</span> persistentIpPortClientManager <span class="token operator">:</span> ephemeralIpPortClientManager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isConnectionBasedClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>clientId<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">IpPortBasedClient</span><span class="token punctuation">.</span>ID_DELIMITER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3、服务端模块的一致性协议委派处理"><a href="#_3、服务端模块的一致性协议委派处理" class="header-anchor">#</a> 3、服务端模块的一致性协议委派处理</h3> <p>Nacos服务端在处理服务一致性协议相关的时候，也采委派模式去选择Distro协议处理业务还是Raft协议处理业务，代码注入如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;consistencyDelegate&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">ConsistencyService</span> consistencyService<span class="token punctuation">;</span>
</code></pre></div><p>所以角色对应关系如下：</p> <table><thead><tr><th>角色名称</th> <th>对应接口/类</th></tr></thead> <tbody><tr><td>抽象任务角色</td> <td>ConsistencyService</td></tr> <tr><td>委派角色</td> <td>DelegateConsistencyServiceImpl</td></tr> <tr><td>具体任务角色</td> <td>PersistentConsistencyServiceDelegateImpl、EphemeralConsistencyService</td></tr></tbody></table> <p>可以看到针对持久化协议的设计，本身又是一个内部委派处理方式，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">&quot;ProtocolManager&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;consistencyDelegate&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelegateConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ConsistencyService</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PersistentConsistencyServiceDelegateImpl</span> persistentConsistencyService<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EphemeralConsistencyService</span> ephemeralConsistencyService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">DelegateConsistencyServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">PersistentConsistencyServiceDelegateImpl</span> persistentConsistencyService<span class="token punctuation">,</span>
            <span class="token class-name">EphemeralConsistencyService</span> ephemeralConsistencyService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>persistentConsistencyService <span class="token operator">=</span> persistentConsistencyService<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ephemeralConsistencyService <span class="token operator">=</span> ephemeralConsistencyService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 		
  	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{</span>
        <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	
  	<span class="token comment">/**
  	* 委派同时满足
  	*/</span>
  	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ephemeralConsistencyService<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> persistentConsistencyService<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">/**
  	* 委派判断条件
  	*/</span>
  	<span class="token keyword">private</span> <span class="token class-name">ConsistencyService</span> <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchEphemeralKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> ephemeralConsistencyService <span class="token operator">:</span> persistentConsistencyService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre></div><p>在Nacos2.1中，针对持久化协议的委派处理，PersistentConsistencyServiceDelegateImpl，相关角色对应关系如下：</p> <table><thead><tr><th>角色名称</th> <th>对应接口/类</th></tr></thead> <tbody><tr><td>抽象任务角色</td> <td>PersistentConsistencyService</td></tr> <tr><td>委派角色</td> <td>PersistentConsistencyServiceDelegateImpl</td></tr> <tr><td>具体任务角色</td> <td>RaftConsistencyServiceImpl、BasePersistentServiceProcessor</td></tr></tbody></table> <p>判断规则如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">PersistentConsistencyService</span> <span class="token function">switchOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> switchNewPersistentService <span class="token operator">?</span> newPersistentConsistencyService <span class="token operator">:</span> oldPersistentConsistencyService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在Nacos中类似使用委派模式的地方还有很多，可以看到通过该模式，让我们对于任务的分配和委派很清晰。对于我们业务开发其实也是有帮助的，日常业务开发中，多思考下企业对于一些兼容类型的处理或扩展类型的处理都可以用到该模式去处理。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/3/2022, 5:50:00 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/nacos-guide/pattern/第2节.Nacos中的模板方法设计模式的使用.html">
        第2节.Nacos中的模板方法设计模式的使用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nacos-guide/assets/js/app.60b565f1.js" defer></script><script src="/nacos-guide/assets/js/2.bcb8ada0.js" defer></script><script src="/nacos-guide/assets/js/45.23034a35.js" defer></script>
  </body>
</html>
